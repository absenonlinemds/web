<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absen Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 3px solid #10b981;
            border-radius: 50%;
            pointer-events: none;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-white text-2xl">👤</span>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Sistem Absen Online</h1>
                <p class="text-gray-600 mt-2">Masuk ke akun Anda</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan username">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan password">
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                    Masuk
                </button>
            </form>
            
            <div id="loginError" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
                Username atau password salah!
            </div>
            
            <div class="text-center mt-4">
                <button type="button" onclick="showPasswordReset()" class="text-blue-600 hover:underline text-sm">
                    Lupa Password?
                </button>
            </div>

        </div>
    </div>

    <!-- Employee Dashboard -->
    <div id="employeePage" class="hidden min-h-screen">
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <span class="text-xl font-semibold text-gray-800">Dashboard Karyawan</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="employeeName" class="text-gray-600"></span>
                        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200">
                            Keluar
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-4xl mx-auto p-6">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Absen Card -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Absen Hari Ini</h2>
                    <div class="text-center">
                        <div id="currentTime" class="text-2xl font-bold text-blue-600 mb-4"></div>
                        <div id="currentDate" class="text-gray-600 mb-6"></div>
                        
                        <div class="space-y-3">
                            <button id="checkInBtn" onclick="startAttendance('in')" class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition duration-200 font-medium">
                                ✅ Absen Masuk
                            </button>
                            <button id="checkOutBtn" onclick="startAttendance('out')" class="w-full bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 transition duration-200 font-medium" disabled>
                                🚪 Absen Keluar
                            </button>
                        </div>
                        
                        <div id="attendanceStatus" class="mt-4 p-3 rounded-lg hidden"></div>
                    </div>
                </div>

                <!-- Status Card -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Status Absen Hari Ini</h2>
                    <div id="todayStatus" class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="text-gray-600">Jam Masuk:</span>
                            <span id="checkInTime" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="text-gray-600">Jam Keluar:</span>
                            <span id="checkOutTime" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="text-gray-600">Total Jam:</span>
                            <span id="totalHours" class="font-medium">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Riwayat Absen -->
            <div class="mt-6 bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Riwayat Absen (7 Hari Terakhir)</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4 font-medium text-gray-600">Tanggal</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-600">Jam Masuk</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-600">Jam Keluar</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-600">Total Jam</th>
                            </tr>
                        </thead>
                        <tbody id="employeeHistory">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminPage" class="hidden min-h-screen">
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <span class="text-xl font-semibold text-gray-800">Dashboard Admin</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-600">Admin</span>
                        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200">
                            Keluar
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto p-6">
            <!-- Stats Cards -->
            <div class="grid md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center">
                        <div class="bg-blue-100 p-3 rounded-full">
                            <span class="text-2xl">👥</span>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Total Karyawan</p>
                            <p class="text-2xl font-bold text-gray-800">3</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center">
                        <div class="bg-green-100 p-3 rounded-full">
                            <span class="text-2xl">✅</span>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Hadir Hari Ini</p>
                            <p id="presentToday" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center">
                        <div class="bg-orange-100 p-3 rounded-full">
                            <span class="text-2xl">📊</span>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Total Absen</p>
                            <p id="totalAttendance" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="bg-white rounded-xl shadow-lg mb-6">
                <div class="border-b">
                    <nav class="flex space-x-8 px-6">
                        <button id="attendanceTab" onclick="switchTab('attendance')" class="py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-medium">
                            📊 Data Absen
                        </button>
                        <button id="locationTab" onclick="switchTab('location')" class="py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium">
                            🗺️ Lokasi Karyawan
                        </button>
                        <button id="employeeTab" onclick="switchTab('employee')" class="py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium">
                            👥 Kelola Karyawan
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Attendance Tab Content -->
            <div id="attendanceContent">
                <!-- Export Controls -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Export Data Absen</h2>
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Filter Options -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Karyawan</label>
                                <select id="employeeSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="all">Semua Karyawan</option>
                                    <!-- Options will be populated by JavaScript -->
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Periode Export</label>
                                <select id="periodSelect" onchange="toggleDateInputs()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="all">Semua Data</option>
                                    <option value="month">Per Bulan</option>
                                    <option value="year">Per Tahun</option>
                                    <option value="custom">Rentang Tanggal</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Date Inputs -->
                        <div class="space-y-4">
                            <div id="monthYearInputs" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Bulan & Tahun</label>
                                <div class="flex space-x-2">
                                    <select id="monthSelect" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="1">Januari</option>
                                        <option value="2">Februari</option>
                                        <option value="3">Maret</option>
                                        <option value="4">April</option>
                                        <option value="5">Mei</option>
                                        <option value="6">Juni</option>
                                        <option value="7">Juli</option>
                                        <option value="8">Agustus</option>
                                        <option value="9">September</option>
                                        <option value="10">Oktober</option>
                                        <option value="11">November</option>
                                        <option value="12">Desember</option>
                                    </select>
                                    <select id="yearSelect" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <!-- Years will be populated by JavaScript -->
                                    </select>
                                </div>
                            </div>
                            
                            <div id="yearOnlyInput" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Tahun</label>
                                <select id="yearOnlySelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <!-- Years will be populated by JavaScript -->
                                </select>
                            </div>
                            
                            <div id="customDateInputs" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Rentang Tanggal</label>
                                <div class="flex space-x-2">
                                    <div class="flex-1">
                                        <label class="block text-xs text-gray-500 mb-1">Dari Tanggal</label>
                                        <input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="flex-1">
                                        <label class="block text-xs text-gray-500 mb-1">Sampai Tanggal</label>
                                        <input type="date" id="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Export Buttons -->
                    <div class="mt-6 flex flex-wrap gap-3">
                        <button onclick="exportToExcel()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition duration-200 font-medium">
                            📊 Export ke Excel
                        </button>
                        <button onclick="previewData()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                            👁️ Preview Data
                        </button>
                        <button onclick="exportSummary()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition duration-200 font-medium">
                            📈 Export Ringkasan
                        </button>
                    </div>
                    
                    <!-- Preview Results -->
                    <div id="previewResults" class="hidden mt-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-semibold text-gray-800 mb-2">Preview Data Export</h3>
                        <div id="previewContent" class="text-sm text-gray-600"></div>
                    </div>
                </div>
            </div>

            <!-- Location Tab Content -->
            <div id="locationContent" class="hidden">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">Lokasi Karyawan Real-time</h2>
                        <div class="flex space-x-2">
                            <button id="trackingToggle" onclick="toggleLocationTracking()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 font-medium">
                                ▶️ Mulai Tracking
                            </button>
                            <button onclick="refreshLocations()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                                🔄 Refresh Lokasi
                            </button>
                        </div>
                    </div>
                    <div id="trackingStatus" class="mb-4 p-3 bg-gray-100 rounded-lg text-center text-sm text-gray-600">
                        Tracking tidak aktif - Klik "Mulai Tracking" untuk memantau lokasi real-time
                    </div>
                    <div id="map" class="w-full h-96 rounded-lg border"></div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Status Lokasi Karyawan</h3>
                    <div id="locationStatus" class="space-y-3">
                        <!-- Location status will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Employee Management Tab Content -->
            <div id="employeeContent" class="hidden">
                <!-- Add New Employee -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Tambah Karyawan Baru</h2>
                    <div class="grid md:grid-cols-3 gap-4">
                        <input type="text" id="newEmployeeName" placeholder="Nama Lengkap" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="newEmployeeUsername" placeholder="Username" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <input type="password" id="newEmployeePassword" placeholder="Password" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mt-4">
                        <button onclick="addNewEmployee()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition duration-200 font-medium">
                            ➕ Tambah Karyawan
                        </button>
                    </div>
                </div>

                <!-- Employee List -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Daftar Karyawan</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b">
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Nama</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Username</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Password</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Total Absen</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="employeeListTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

                <!-- Attendance Table -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Data Absen Karyawan</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b">
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Nama</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Tanggal</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Jam Masuk</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Jam Keluar</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Total Jam</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Status</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="adminAttendanceTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Selfie Modal -->
    <div id="selfieModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <div class="text-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Ambil Foto Selfie</h3>
                <p class="text-sm text-gray-600">Pastikan Anda berada di area kantor</p>
            </div>
            
            <!-- Location Status -->
            <div id="locationStatus" class="mb-4 p-3 rounded-lg text-center">
                <div class="flex items-center justify-center space-x-2">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                    <span class="text-sm">Mengecek lokasi...</span>
                </div>
            </div>
            
            <!-- Camera Container -->
            <div id="cameraContainer" class="hidden">
                <div class="camera-container mb-4">
                    <video id="video" autoplay playsinline class="w-full h-64 object-cover rounded-lg bg-gray-200"></video>
                    <div class="camera-overlay"></div>
                </div>
                
                <canvas id="canvas" class="hidden"></canvas>
                
                <div class="flex space-x-3">
                    <button id="captureBtn" onclick="capturePhoto()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                        📸 Ambil Foto
                    </button>
                    <button onclick="closeSelfieModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition duration-200 font-medium">
                        Batal
                    </button>
                </div>
            </div>
            
            <!-- Photo Preview -->
            <div id="photoPreview" class="hidden">
                <img id="capturedPhoto" class="w-full h-64 object-cover rounded-lg mb-4" alt="Captured photo">
                <div class="flex space-x-3">
                    <button id="confirmBtn" onclick="confirmAttendance()" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition duration-200 font-medium">
                        ✅ Konfirmasi Absen
                    </button>
                    <button onclick="retakePhoto()" class="flex-1 bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 transition duration-200 font-medium">
                        🔄 Foto Ulang
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Viewer Modal -->
    <div id="photoViewerModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Foto Absen</h3>
                <button onclick="closePhotoViewer()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <img id="viewerPhoto" class="w-full h-auto rounded-lg" alt="Attendance photo">
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div id="passwordResetModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Reset Password</h3>
                <button onclick="closePasswordReset()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div id="resetStep1">
                <p class="text-gray-600 mb-4">Masukkan username Anda untuk reset password:</p>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="resetUsername" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Masukkan username">
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="checkUsername()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                            🔍 Cek Username
                        </button>
                        <button onclick="closePasswordReset()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition duration-200 font-medium">
                            Batal
                        </button>
                    </div>
                </div>
                
                <div id="usernameError" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
                    Username tidak ditemukan!
                </div>
            </div>
            
            <div id="resetStep2" class="hidden">
                <div class="text-center mb-4">
                    <div class="bg-green-100 p-3 rounded-full w-16 h-16 mx-auto mb-3 flex items-center justify-center">
                        <span class="text-2xl">✅</span>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-800">Username Ditemukan!</h4>
                    <p class="text-gray-600 mt-2">Nama: <span id="foundUserName" class="font-medium"></span></p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password Baru</label>
                        <input type="password" id="newPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Masukkan password baru">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Konfirmasi Password</label>
                        <input type="password" id="confirmPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Konfirmasi password baru">
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="resetPassword()" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition duration-200 font-medium">
                            🔐 Reset Password
                        </button>
                        <button onclick="backToStep1()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition duration-200 font-medium">
                            Kembali
                        </button>
                    </div>
                </div>
                
                <div id="passwordError" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden"></div>
            </div>
            
            <div id="resetStep3" class="hidden">
                <div class="text-center">
                    <div class="bg-green-100 p-3 rounded-full w-16 h-16 mx-auto mb-3 flex items-center justify-center">
                        <span class="text-2xl">🎉</span>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Password Berhasil Direset!</h4>
                    <p class="text-gray-600 mb-4">Anda sekarang dapat login dengan password baru.</p>
                    
                    <button onclick="closePasswordResetSuccess()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                        ✅ Kembali ke Login
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Attendance Modal -->
    <div id="editAttendanceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Edit Data Absen</h3>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Karyawan</label>
                    <input type="text" id="editEmployeeName" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                    <input type="text" id="editDate" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jam Masuk</label>
                    <input type="time" id="editCheckIn" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jam Keluar</label>
                    <input type="time" id="editCheckOut" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button onclick="saveAttendanceEdit()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                        💾 Simpan Perubahan
                    </button>
                    <button onclick="closeEditModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition duration-200 font-medium">
                        Batal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // User accounts - Load from localStorage or use defaults
        let users = JSON.parse(localStorage.getItem('users')) || {
            'dede': { password: 'dede1', name: 'Dede', role: 'employee' },
            'wawan': { password: 'wawan1', name: 'Wawan', role: 'employee' },
            'ebi': { password: 'ebi1', name: 'Ebi', role: 'employee' },
            'admin': { password: 'mmd01', name: 'Admin', role: 'admin' }
        };

        let currentUser = null;
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || {};
        let currentAttendanceType = null;
        let capturedPhotoData = null;
        let videoStream = null;
        let map = null;
        let employeeMarkers = {};
        let locationData = JSON.parse(localStorage.getItem('locationData')) || {};
        let locationTrackingInterval = null;
        let isTrackingActive = false;
        let currentEditUsername = null;
        let currentEditDate = null;
        
        // Office location (specific coordinates provided)
        const officeLocation = {
            lat: -6.2190665,
            lng: 106.0912750,
            radius: 100 // 100 meters radius
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            
            // Check for saved session
            checkSavedSession();
            
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                login();
            });
        });

        function updateTime() {
            const now = new Date();
            const timeElement = document.getElementById('currentTime');
            const dateElement = document.getElementById('currentDate');
            
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString('id-ID');
            }
            if (dateElement) {
                dateElement.textContent = now.toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
        }

        function checkSavedSession() {
            const savedSession = localStorage.getItem('currentSession');
            
            if (savedSession) {
                try {
                    const sessionData = JSON.parse(savedSession);
                    
                    // Verify user still exists and password hasn't changed
                    if (users[sessionData.username] && 
                        users[sessionData.username].password === sessionData.password) {
                        
                        currentUser = sessionData;
                        document.getElementById('loginPage').classList.add('hidden');
                        
                        if (currentUser.role === 'admin') {
                            showAdminDashboard();
                        } else {
                            showEmployeeDashboard();
                        }
                    } else {
                        // Session invalid, clear it
                        localStorage.removeItem('currentSession');
                    }
                } catch (error) {
                    // Invalid session data, clear it
                    localStorage.removeItem('currentSession');
                }
            }
        }

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            if (users[username] && users[username].password === password) {
                currentUser = { username, ...users[username] };
                errorDiv.classList.add('hidden');
                
                // Save session to localStorage
                localStorage.setItem('currentSession', JSON.stringify(currentUser));
                
                document.getElementById('loginPage').classList.add('hidden');
                
                if (currentUser.role === 'admin') {
                    showAdminDashboard();
                } else {
                    showEmployeeDashboard();
                }
            } else {
                errorDiv.classList.remove('hidden');
            }
        }

        function showEmployeeDashboard() {
            document.getElementById('employeePage').classList.remove('hidden');
            document.getElementById('employeeName').textContent = currentUser.name;
            
            updateEmployeeStatus();
            loadEmployeeHistory();
            startEmployeeLocationTracking();
        }

        function showAdminDashboard() {
            document.getElementById('adminPage').classList.remove('hidden');
            updateAdminStats();
            loadAdminAttendanceTable();
            populateEmployeeSelect();
        }

        function populateEmployeeSelect() {
            const employeeSelect = document.getElementById('employeeSelect');
            
            // Clear existing options except "Semua Karyawan"
            employeeSelect.innerHTML = '<option value="all">Semua Karyawan</option>';
            
            // Add employee options
            Object.keys(users).forEach(username => {
                if (users[username].role === 'employee') {
                    const option = document.createElement('option');
                    option.value = username;
                    option.textContent = users[username].name;
                    employeeSelect.appendChild(option);
                }
            });
        }

        function updateEmployeeStatus() {
            const today = new Date().toDateString();
            const userAttendance = attendanceData[currentUser.username] || {};
            const todayRecord = userAttendance[today];

            const checkInBtn = document.getElementById('checkInBtn');
            const checkOutBtn = document.getElementById('checkOutBtn');
            const checkInTime = document.getElementById('checkInTime');
            const checkOutTime = document.getElementById('checkOutTime');
            const totalHours = document.getElementById('totalHours');

            if (todayRecord) {
                checkInTime.textContent = todayRecord.checkIn || '-';
                checkOutTime.textContent = todayRecord.checkOut || '-';
                
                if (todayRecord.checkIn && todayRecord.checkOut) {
                    const duration = calculateDuration(todayRecord.checkIn, todayRecord.checkOut);
                    totalHours.textContent = duration;
                    checkInBtn.disabled = true;
                    checkOutBtn.disabled = true;
                } else if (todayRecord.checkIn) {
                    checkInBtn.disabled = true;
                    checkOutBtn.disabled = false;
                    totalHours.textContent = '-';
                }
            } else {
                checkInTime.textContent = '-';
                checkOutTime.textContent = '-';
                totalHours.textContent = '-';
                checkInBtn.disabled = false;
                checkOutBtn.disabled = true;
            }
        }

        function startAttendance(type) {
            currentAttendanceType = type;
            document.getElementById('selfieModal').classList.remove('hidden');
            checkLocationAndStartCamera();
        }

        function checkLocationAndStartCamera() {
            const locationStatus = document.getElementById('locationStatus');
            
            if (!navigator.geolocation) {
                locationStatus.innerHTML = `
                    <div class="bg-red-100 text-red-700 p-3 rounded-lg">
                        <p class="text-sm">Geolocation tidak didukung browser Anda</p>
                        <p class="text-xs mt-1">Melanjutkan tanpa verifikasi lokasi...</p>
                    </div>
                `;
                setTimeout(() => {
                    startCamera();
                }, 2000);
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    const distance = calculateDistance(userLat, userLng, officeLocation.lat, officeLocation.lng);
                    
                    if (distance <= officeLocation.radius) {
                        locationStatus.innerHTML = `
                            <div class="bg-green-100 text-green-700 p-3 rounded-lg">
                                <div class="flex items-center justify-center space-x-2">
                                    <span class="text-green-600">✅</span>
                                    <span class="text-sm">Lokasi valid - Anda di area kantor</span>
                                </div>
                                <p class="text-xs mt-1">Jarak: ${Math.round(distance)}m dari kantor</p>
                            </div>
                        `;
                        setTimeout(() => {
                            startCamera();
                        }, 1500);
                    } else {
                        locationStatus.innerHTML = `
                            <div class="bg-red-100 text-red-700 p-3 rounded-lg">
                                <div class="flex items-center justify-center space-x-2">
                                    <span class="text-red-600">❌</span>
                                    <span class="text-sm">Anda tidak berada di area kantor</span>
                                </div>
                                <p class="text-xs mt-1">Jarak: ${Math.round(distance)}m dari kantor (max: ${officeLocation.radius}m)</p>
                                <button onclick="closeSelfieModal()" class="mt-2 bg-red-600 text-white px-4 py-2 rounded text-xs hover:bg-red-700">
                                    Tutup
                                </button>
                            </div>
                        `;
                    }
                },
                (error) => {
                    locationStatus.innerHTML = `
                        <div class="bg-yellow-100 text-yellow-700 p-3 rounded-lg">
                            <p class="text-sm">Tidak dapat mengakses lokasi</p>
                            <p class="text-xs mt-1">Melanjutkan tanpa verifikasi lokasi...</p>
                        </div>
                    `;
                    setTimeout(() => {
                        startCamera();
                    }, 2000);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3; // Earth's radius in meters
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lng2-lng1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        function startCamera() {
            document.getElementById('locationStatus').classList.add('hidden');
            document.getElementById('cameraContainer').classList.remove('hidden');
            
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'user',
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                } 
            })
            .then(stream => {
                videoStream = stream;
                const video = document.getElementById('video');
                video.srcObject = stream;
            })
            .catch(err => {
                console.error('Error accessing camera:', err);
                showMessage('Tidak dapat mengakses kamera', 'error');
                closeSelfieModal();
            });
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Flip the image horizontally for selfie effect
            context.scale(-1, 1);
            context.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
            
            capturedPhotoData = canvas.toDataURL('image/jpeg', 0.8);
            
            document.getElementById('capturedPhoto').src = capturedPhotoData;
            document.getElementById('cameraContainer').classList.add('hidden');
            document.getElementById('photoPreview').classList.remove('hidden');
            
            // Stop video stream
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
        }

        function retakePhoto() {
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('locationStatus').classList.remove('hidden');
            capturedPhotoData = null;
            checkLocationAndStartCamera();
        }

        function confirmAttendance() {
            const today = new Date().toDateString();
            const now = new Date().toLocaleTimeString('id-ID');
            
            if (!attendanceData[currentUser.username]) {
                attendanceData[currentUser.username] = {};
            }
            
            // Get current location for tracking
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    
                    // Store location data
                    if (!locationData[currentUser.username]) {
                        locationData[currentUser.username] = {};
                    }
                    
                    locationData[currentUser.username][today] = {
                        ...locationData[currentUser.username][today],
                        [`${currentAttendanceType}Location`]: {
                            lat: userLat,
                            lng: userLng,
                            timestamp: now
                        }
                    };
                    
                    localStorage.setItem('locationData', JSON.stringify(locationData));
                },
                (error) => {
                    console.log('Location tracking failed:', error);
                }
            );
            
            if (currentAttendanceType === 'in') {
                attendanceData[currentUser.username][today] = {
                    checkIn: now,
                    checkOut: null,
                    checkInPhoto: capturedPhotoData
                };
                showMessage('Absen masuk berhasil!', 'success');
            } else {
                if (attendanceData[currentUser.username][today]) {
                    attendanceData[currentUser.username][today].checkOut = now;
                    attendanceData[currentUser.username][today].checkOutPhoto = capturedPhotoData;
                }
                showMessage('Absen keluar berhasil!', 'success');
            }
            
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            updateEmployeeStatus();
            closeSelfieModal();
        }

        function closeSelfieModal() {
            document.getElementById('selfieModal').classList.add('hidden');
            document.getElementById('locationStatus').classList.remove('hidden');
            document.getElementById('cameraContainer').classList.add('hidden');
            document.getElementById('photoPreview').classList.add('hidden');
            
            // Reset status
            document.getElementById('locationStatus').innerHTML = `
                <div class="flex items-center justify-center space-x-2">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                    <span class="text-sm">Mengecek lokasi...</span>
                </div>
            `;
            
            // Stop video stream if active
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            capturedPhotoData = null;
            currentAttendanceType = null;
        }

        function showMessage(message, type) {
            const statusDiv = document.getElementById('attendanceStatus');
            statusDiv.textContent = message;
            statusDiv.className = `mt-4 p-3 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            statusDiv.classList.remove('hidden');
            
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 3000);
        }

        function loadEmployeeHistory() {
            const tbody = document.getElementById('employeeHistory');
            const userAttendance = attendanceData[currentUser.username] || {};
            
            tbody.innerHTML = '';
            
            // Get last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateString = date.toDateString();
                const displayDate = date.toLocaleDateString('id-ID');
                
                const record = userAttendance[dateString];
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                const duration = record && record.checkIn && record.checkOut ? 
                    calculateDuration(record.checkIn, record.checkOut) : '-';
                
                row.innerHTML = `
                    <td class="py-3 px-4">${displayDate}</td>
                    <td class="py-3 px-4">${record?.checkIn || '-'}</td>
                    <td class="py-3 px-4">${record?.checkOut || '-'}</td>
                    <td class="py-3 px-4">${duration}</td>
                `;
                
                tbody.appendChild(row);
            }
        }

        function updateAdminStats() {
            const today = new Date().toDateString();
            let presentToday = 0;
            let totalRecords = 0;
            
            Object.keys(attendanceData).forEach(username => {
                const userRecords = attendanceData[username];
                totalRecords += Object.keys(userRecords).length;
                
                if (userRecords[today] && userRecords[today].checkIn) {
                    presentToday++;
                }
            });
            
            document.getElementById('presentToday').textContent = presentToday;
            document.getElementById('totalAttendance').textContent = totalRecords;
        }

        function loadAdminAttendanceTable() {
            const tbody = document.getElementById('adminAttendanceTable');
            tbody.innerHTML = '';
            
            Object.keys(attendanceData).forEach(username => {
                const userRecords = attendanceData[username];
                const userName = users[username]?.name || username;
                
                Object.keys(userRecords).forEach(dateString => {
                    const record = userRecords[dateString];
                    const date = new Date(dateString);
                    const displayDate = date.toLocaleDateString('id-ID');
                    
                    const duration = record.checkIn && record.checkOut ? 
                        calculateDuration(record.checkIn, record.checkOut) : '-';
                    
                    let status = 'Tidak Lengkap';
                    if (record.checkIn && record.checkOut) {
                        status = 'Lengkap';
                    } else if (record.checkIn) {
                        status = 'Belum Absen Keluar';
                    }
                    
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-4 font-medium">${userName}</td>
                        <td class="py-3 px-4">${displayDate}</td>
                        <td class="py-3 px-4">
                            ${record.checkIn || '-'}
                            ${record.checkInPhoto ? '<br><button onclick="viewPhoto(\'' + record.checkInPhoto + '\')" class="text-xs text-blue-600 hover:underline">📷 Lihat Foto</button>' : ''}
                        </td>
                        <td class="py-3 px-4">
                            ${record.checkOut || '-'}
                            ${record.checkOutPhoto ? '<br><button onclick="viewPhoto(\'' + record.checkOutPhoto + '\')" class="text-xs text-blue-600 hover:underline">📷 Lihat Foto</button>' : ''}
                        </td>
                        <td class="py-3 px-4">${duration}</td>
                        <td class="py-3 px-4">
                            <span class="px-2 py-1 text-xs rounded-full ${status === 'Lengkap' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${status}
                            </span>
                        </td>
                        <td class="py-3 px-4">
                            <div class="flex space-x-1">
                                <button onclick="editAttendance('${username}', '${dateString}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">
                                    ✏️ Edit
                                </button>
                                <button onclick="deleteAttendance('${username}', '${dateString}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                                    🗑️ Hapus
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        function calculateDuration(checkIn, checkOut) {
            const [inHour, inMin, inSec] = checkIn.split(':').map(Number);
            const [outHour, outMin, outSec] = checkOut.split(':').map(Number);
            
            const inMinutes = inHour * 60 + inMin;
            const outMinutes = outHour * 60 + outMin;
            
            let diffMinutes = outMinutes - inMinutes;
            if (diffMinutes < 0) diffMinutes += 24 * 60; // Handle next day
            
            const hours = Math.floor(diffMinutes / 60);
            const minutes = diffMinutes % 60;
            
            return `${hours}j ${minutes}m`;
        }

        function toggleDateInputs() {
            const periodSelect = document.getElementById('periodSelect').value;
            const monthYearInputs = document.getElementById('monthYearInputs');
            const yearOnlyInput = document.getElementById('yearOnlyInput');
            const customDateInputs = document.getElementById('customDateInputs');
            
            // Hide all inputs first
            monthYearInputs.classList.add('hidden');
            yearOnlyInput.classList.add('hidden');
            customDateInputs.classList.add('hidden');
            
            // Show relevant inputs
            if (periodSelect === 'month') {
                monthYearInputs.classList.remove('hidden');
                populateYearOptions();
            } else if (periodSelect === 'year') {
                yearOnlyInput.classList.remove('hidden');
                populateYearOnlyOptions();
            } else if (periodSelect === 'custom') {
                customDateInputs.classList.remove('hidden');
                setDefaultDateRange();
            }
        }

        function populateYearOptions() {
            const yearSelect = document.getElementById('yearSelect');
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            
            yearSelect.innerHTML = '';
            
            // Get years from attendance data
            const years = new Set();
            Object.keys(attendanceData).forEach(username => {
                Object.keys(attendanceData[username]).forEach(dateString => {
                    const year = new Date(dateString).getFullYear();
                    years.add(year);
                });
            });
            
            // Add current year if no data exists
            if (years.size === 0) {
                years.add(currentYear);
            }
            
            // Sort years and populate select
            Array.from(years).sort((a, b) => b - a).forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            });
            
            // Set current month
            document.getElementById('monthSelect').value = currentMonth;
        }

        function populateYearOnlyOptions() {
            const yearOnlySelect = document.getElementById('yearOnlySelect');
            const currentYear = new Date().getFullYear();
            
            yearOnlySelect.innerHTML = '';
            
            // Get years from attendance data
            const years = new Set();
            Object.keys(attendanceData).forEach(username => {
                Object.keys(attendanceData[username]).forEach(dateString => {
                    const year = new Date(dateString).getFullYear();
                    years.add(year);
                });
            });
            
            // Add current year if no data exists
            if (years.size === 0) {
                years.add(currentYear);
            }
            
            // Sort years and populate select
            Array.from(years).sort((a, b) => b - a).forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearOnlySelect.appendChild(option);
            });
        }

        function setDefaultDateRange() {
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('startDate').value = firstDayOfMonth.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        }

        function getFilteredData() {
            const selectedEmployee = document.getElementById('employeeSelect').value;
            const periodSelect = document.getElementById('periodSelect').value;
            const filteredData = [];
            
            Object.keys(attendanceData).forEach(username => {
                if (selectedEmployee !== 'all' && username !== selectedEmployee) return;
                
                const userRecords = attendanceData[username];
                const userName = users[username]?.name || username;
                
                Object.keys(userRecords).forEach(dateString => {
                    const record = userRecords[dateString];
                    const date = new Date(dateString);
                    
                    // Apply date filter
                    if (!isDateInRange(date, periodSelect)) return;
                    
                    const displayDate = date.toLocaleDateString('id-ID');
                    const duration = record.checkIn && record.checkOut ? 
                        calculateDuration(record.checkIn, record.checkOut) : '-';
                    
                    let status = 'Tidak Lengkap';
                    if (record.checkIn && record.checkOut) {
                        status = 'Lengkap';
                    } else if (record.checkIn) {
                        status = 'Belum Absen Keluar';
                    }
                    
                    filteredData.push({
                        nama: userName,
                        tanggal: displayDate,
                        jamMasuk: record.checkIn || '-',
                        jamKeluar: record.checkOut || '-',
                        totalJam: duration,
                        status: status,
                        dateObj: date,
                        username: username
                    });
                });
            });
            
            // Sort by date (newest first)
            filteredData.sort((a, b) => b.dateObj - a.dateObj);
            
            return filteredData;
        }

        function isDateInRange(date, periodType) {
            if (periodType === 'all') return true;
            
            if (periodType === 'month') {
                const selectedMonth = parseInt(document.getElementById('monthSelect').value);
                const selectedYear = parseInt(document.getElementById('yearSelect').value);
                return date.getMonth() + 1 === selectedMonth && date.getFullYear() === selectedYear;
            }
            
            if (periodType === 'year') {
                const selectedYear = parseInt(document.getElementById('yearOnlySelect').value);
                return date.getFullYear() === selectedYear;
            }
            
            if (periodType === 'custom') {
                const startDate = new Date(document.getElementById('startDate').value);
                const endDate = new Date(document.getElementById('endDate').value);
                endDate.setHours(23, 59, 59, 999); // Include the end date
                return date >= startDate && date <= endDate;
            }
            
            return true;
        }

        function exportToExcel() {
            const filteredData = getFilteredData();
            const selectedEmployee = document.getElementById('employeeSelect').value;
            const periodSelect = document.getElementById('periodSelect').value;
            
            if (filteredData.length === 0) {
                alert('Tidak ada data untuk diekspor dengan filter yang dipilih!');
                return;
            }
            
            const data = [];
            
            // Headers
            data.push(['Nama', 'Tanggal', 'Jam Masuk', 'Jam Keluar', 'Total Jam', 'Status']);
            
            // Data rows
            filteredData.forEach(row => {
                data.push([
                    row.nama,
                    row.tanggal,
                    row.jamMasuk,
                    row.jamKeluar,
                    row.totalJam,
                    row.status
                ]);
            });
            
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Auto-size columns
            const colWidths = [
                { wch: 15 }, // Nama
                { wch: 12 }, // Tanggal
                { wch: 12 }, // Jam Masuk
                { wch: 12 }, // Jam Keluar
                { wch: 10 }, // Total Jam
                { wch: 15 }  // Status
            ];
            ws['!cols'] = colWidths;
            
            // Add worksheet to workbook
            const employeeName = selectedEmployee === 'all' ? 'Semua_Karyawan' : users[selectedEmployee]?.name || selectedEmployee;
            const periodName = getPeriodName(periodSelect);
            const sheetName = `${employeeName}_${periodName}`;
            
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            
            // Save file
            const fileName = `Data_Absen_${sheetName}_${new Date().toLocaleDateString('id-ID').replace(/\//g, '-')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            // Show success message
            showExportMessage(`Data berhasil diekspor! File: ${fileName}`, 'success');
        }

        function exportSummary() {
            const filteredData = getFilteredData();
            const selectedEmployee = document.getElementById('employeeSelect').value;
            const periodSelect = document.getElementById('periodSelect').value;
            
            if (filteredData.length === 0) {
                alert('Tidak ada data untuk diekspor dengan filter yang dipilih!');
                return;
            }
            
            // Create summary data
            const summaryData = [];
            const employeeSummary = {};
            
            // Group data by employee
            filteredData.forEach(row => {
                if (!employeeSummary[row.username]) {
                    employeeSummary[row.username] = {
                        nama: row.nama,
                        totalHari: 0,
                        hariLengkap: 0,
                        hariTidakLengkap: 0,
                        totalJamKerja: 0
                    };
                }
                
                const summary = employeeSummary[row.username];
                summary.totalHari++;
                
                if (row.status === 'Lengkap') {
                    summary.hariLengkap++;
                    // Calculate total working hours
                    if (row.totalJam !== '-') {
                        const [hours, minutes] = row.totalJam.replace('j', '').replace('m', '').split(' ').map(Number);
                        summary.totalJamKerja += hours + (minutes / 60);
                    }
                } else {
                    summary.hariTidakLengkap++;
                }
            });
            
            // Headers for summary
            summaryData.push(['RINGKASAN DATA ABSEN']);
            summaryData.push(['Periode:', getPeriodName(periodSelect)]);
            summaryData.push(['Karyawan:', selectedEmployee === 'all' ? 'Semua Karyawan' : users[selectedEmployee]?.name]);
            summaryData.push(['Tanggal Export:', new Date().toLocaleDateString('id-ID')]);
            summaryData.push([]);
            summaryData.push(['Nama Karyawan', 'Total Hari', 'Hari Lengkap', 'Hari Tidak Lengkap', 'Total Jam Kerja', 'Rata-rata Jam/Hari']);
            
            // Summary rows
            Object.values(employeeSummary).forEach(summary => {
                const avgHours = summary.hariLengkap > 0 ? (summary.totalJamKerja / summary.hariLengkap).toFixed(1) : 0;
                summaryData.push([
                    summary.nama,
                    summary.totalHari,
                    summary.hariLengkap,
                    summary.hariTidakLengkap,
                    `${Math.floor(summary.totalJamKerja)}j ${Math.round((summary.totalJamKerja % 1) * 60)}m`,
                    `${avgHours} jam`
                ]);
            });
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(summaryData);
            
            // Style the header
            ws['A1'].s = {
                font: { bold: true, sz: 14 },
                alignment: { horizontal: 'center' }
            };
            
            // Auto-size columns
            const colWidths = [
                { wch: 20 }, // Nama Karyawan
                { wch: 12 }, // Total Hari
                { wch: 12 }, // Hari Lengkap
                { wch: 15 }, // Hari Tidak Lengkap
                { wch: 15 }, // Total Jam Kerja
                { wch: 15 }  // Rata-rata Jam/Hari
            ];
            ws['!cols'] = colWidths;
            
            // Add worksheet to workbook
            const employeeName = selectedEmployee === 'all' ? 'Semua_Karyawan' : users[selectedEmployee]?.name || selectedEmployee;
            const periodName = getPeriodName(periodSelect);
            const sheetName = `Ringkasan_${employeeName}_${periodName}`;
            
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            
            // Save file
            const fileName = `Ringkasan_Absen_${sheetName}_${new Date().toLocaleDateString('id-ID').replace(/\//g, '-')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            // Show success message
            showExportMessage(`Ringkasan berhasil diekspor! File: ${fileName}`, 'success');
        }

        function previewData() {
            const filteredData = getFilteredData();
            const previewResults = document.getElementById('previewResults');
            const previewContent = document.getElementById('previewContent');
            
            if (filteredData.length === 0) {
                previewContent.innerHTML = '<p class="text-red-600">Tidak ada data dengan filter yang dipilih.</p>';
                previewResults.classList.remove('hidden');
                return;
            }
            
            // Create preview summary
            const employeeCount = new Set(filteredData.map(row => row.username)).size;
            const completeRecords = filteredData.filter(row => row.status === 'Lengkap').length;
            const incompleteRecords = filteredData.length - completeRecords;
            
            const periodName = getPeriodName(document.getElementById('periodSelect').value);
            const employeeName = document.getElementById('employeeSelect').value === 'all' ? 'Semua Karyawan' : users[document.getElementById('employeeSelect').value]?.name;
            
            previewContent.innerHTML = `
                <div class="space-y-2">
                    <p><strong>Periode:</strong> ${periodName}</p>
                    <p><strong>Karyawan:</strong> ${employeeName}</p>
                    <p><strong>Total Record:</strong> ${filteredData.length} data</p>
                    <p><strong>Jumlah Karyawan:</strong> ${employeeCount} orang</p>
                    <p><strong>Absen Lengkap:</strong> ${completeRecords} hari</p>
                    <p><strong>Absen Tidak Lengkap:</strong> ${incompleteRecords} hari</p>
                    <p class="text-xs text-gray-500 mt-2">
                        Rentang tanggal: ${filteredData[filteredData.length - 1]?.tanggal} - ${filteredData[0]?.tanggal}
                    </p>
                </div>
            `;
            
            previewResults.classList.remove('hidden');
        }

        function getPeriodName(periodType) {
            if (periodType === 'all') return 'Semua_Data';
            
            if (periodType === 'month') {
                const monthNames = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                                 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                const month = document.getElementById('monthSelect').value;
                const year = document.getElementById('yearSelect').value;
                return `${monthNames[month]}_${year}`;
            }
            
            if (periodType === 'year') {
                const year = document.getElementById('yearOnlySelect').value;
                return `Tahun_${year}`;
            }
            
            if (periodType === 'custom') {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                return `${startDate}_sampai_${endDate}`;
            }
            
            return 'Data';
        }

        function showExportMessage(message, type) {
            const previewResults = document.getElementById('previewResults');
            const previewContent = document.getElementById('previewContent');
            
            const bgColor = type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700';
            const icon = type === 'success' ? '✅' : '❌';
            
            previewContent.innerHTML = `
                <div class="flex items-center space-x-2 ${bgColor} p-3 rounded-lg">
                    <span>${icon}</span>
                    <span>${message}</span>
                </div>
            `;
            
            previewResults.classList.remove('hidden');
            
            // Hide after 5 seconds
            setTimeout(() => {
                previewResults.classList.add('hidden');
            }, 5000);
        }

        function viewPhoto(photoData) {
            document.getElementById('viewerPhoto').src = photoData;
            document.getElementById('photoViewerModal').classList.remove('hidden');
        }

        function closePhotoViewer() {
            document.getElementById('photoViewerModal').classList.add('hidden');
        }

        // Google Maps Functions
        function initMap() {
            // Initialize map centered on office location
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: { lat: officeLocation.lat, lng: officeLocation.lng },
                mapTypeId: 'roadmap'
            });

            // Add office marker
            const officeMarker = new google.maps.Marker({
                position: { lat: officeLocation.lat, lng: officeLocation.lng },
                map: map,
                title: 'Kantor',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="20" cy="20" r="18" fill="#1f2937" stroke="#fff" stroke-width="2"/>
                            <text x="20" y="26" text-anchor="middle" fill="white" font-size="16">🏢</text>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(40, 40)
                }
            });

            // Add office radius circle
            const officeCircle = new google.maps.Circle({
                strokeColor: '#10b981',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#10b981',
                fillOpacity: 0.15,
                map: map,
                center: { lat: officeLocation.lat, lng: officeLocation.lng },
                radius: officeLocation.radius
            });

            // Load employee locations
            loadEmployeeLocations();
        }

        function switchTab(tab) {
            const attendanceTab = document.getElementById('attendanceTab');
            const locationTab = document.getElementById('locationTab');
            const employeeTab = document.getElementById('employeeTab');
            const attendanceContent = document.getElementById('attendanceContent');
            const locationContent = document.getElementById('locationContent');
            const employeeContent = document.getElementById('employeeContent');

            // Reset all tabs
            attendanceTab.className = 'py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium';
            locationTab.className = 'py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium';
            employeeTab.className = 'py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium';
            
            attendanceContent.classList.add('hidden');
            locationContent.classList.add('hidden');
            employeeContent.classList.add('hidden');

            if (tab === 'attendance') {
                attendanceTab.className = 'py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-medium';
                attendanceContent.classList.remove('hidden');
            } else if (tab === 'location') {
                locationTab.className = 'py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-medium';
                locationContent.classList.remove('hidden');
                
                // Initialize map if not already done
                if (!map) {
                    setTimeout(initMap, 100);
                } else {
                    loadEmployeeLocations();
                }
            } else if (tab === 'employee') {
                employeeTab.className = 'py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-medium';
                employeeContent.classList.remove('hidden');
                loadEmployeeList();
            }
        }

        function loadEmployeeLocations() {
            if (!map) return;

            // Clear existing employee markers
            Object.values(employeeMarkers).forEach(marker => marker.setMap(null));
            employeeMarkers = {};

            const today = new Date().toDateString();
            const now = new Date().getTime();
            const locationStatusDiv = document.getElementById('locationStatus');
            locationStatusDiv.innerHTML = '';

            Object.keys(users).forEach(username => {
                if (users[username].role === 'employee') {
                    const userName = users[username].name;
                    const userLocationData = locationData[username];
                    const todayLocation = userLocationData?.[today];
                    const userAttendance = attendanceData[username] || {};
                    const todayRecord = userAttendance[today];

                    let statusHtml = `
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 rounded-full bg-gray-400"></div>
                                <span class="font-medium">${userName}</span>
                            </div>
                            <span class="text-sm text-gray-500">Tidak ada data lokasi</span>
                        </div>
                    `;

                    if (todayLocation) {
                        // Priority: current location > out location > in location
                        const latestLocation = todayLocation.currentLocation || todayLocation.outLocation || todayLocation.inLocation;
                        
                        if (latestLocation) {
                            const distance = calculateDistance(
                                latestLocation.lat, 
                                latestLocation.lng, 
                                officeLocation.lat, 
                                officeLocation.lng
                            );

                            const isInOffice = distance <= officeLocation.radius;
                            const statusColor = isInOffice ? 'bg-green-400' : 'bg-red-400';
                            const statusText = isInOffice ? 'Di area kantor' : `${Math.round(distance)}m dari kantor`;
                            
                            // Check if employee is currently checked in
                            const isCheckedIn = todayRecord && todayRecord.checkIn && !todayRecord.checkOut;
                            const workStatus = isCheckedIn ? '🟢 Sedang Bekerja' : '🔴 Tidak Bekerja';
                            
                            // Check if location is recent (within 2 minutes)
                            const isRecent = latestLocation.lastUpdate && (now - latestLocation.lastUpdate) < 120000;
                            const locationStatus = isRecent ? '🔴 Live' : '⚪ Offline';

                            statusHtml = `
                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-3 h-3 rounded-full ${statusColor} ${isRecent ? 'animate-pulse' : ''}"></div>
                                        <div>
                                            <span class="font-medium">${userName}</span>
                                            <div class="text-xs text-gray-500">${workStatus} ${locationStatus}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-medium">${statusText}</div>
                                        <div class="text-xs text-gray-500">Update: ${latestLocation.timestamp}</div>
                                    </div>
                                </div>
                            `;

                            // Add marker to map with different colors based on status
                            let markerColor = '#6b7280'; // gray for offline
                            if (isRecent) {
                                markerColor = isInOffice ? '#10b981' : '#ef4444'; // green for in office, red for outside
                            }

                            const marker = new google.maps.Marker({
                                position: { lat: latestLocation.lat, lng: latestLocation.lng },
                                map: map,
                                title: userName,
                                icon: {
                                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                        <svg width="36" height="36" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="18" cy="18" r="16" fill="${markerColor}" stroke="#fff" stroke-width="2"/>
                                            <text x="18" y="23" text-anchor="middle" fill="white" font-size="12">👤</text>
                                            ${isRecent ? '<circle cx="28" cy="8" r="4" fill="#ff0000"><animate attributeName="opacity" values="1;0;1" dur="1s" repeatCount="indefinite"/></circle>' : ''}
                                        </svg>
                                    `),
                                    scaledSize: new google.maps.Size(36, 36)
                                }
                            });

                            // Add info window with more details
                            const infoWindow = new google.maps.InfoWindow({
                                content: `
                                    <div class="p-3">
                                        <h3 class="font-semibold text-lg">${userName}</h3>
                                        <div class="space-y-1 text-sm">
                                            <p><strong>Status:</strong> ${statusText}</p>
                                            <p><strong>Kerja:</strong> ${workStatus}</p>
                                            <p><strong>Lokasi:</strong> ${locationStatus}</p>
                                            <p><strong>Update:</strong> ${latestLocation.timestamp}</p>
                                            ${todayRecord?.checkIn ? `<p><strong>Masuk:</strong> ${todayRecord.checkIn}</p>` : ''}
                                            ${todayRecord?.checkOut ? `<p><strong>Keluar:</strong> ${todayRecord.checkOut}</p>` : ''}
                                        </div>
                                    </div>
                                `
                            });

                            marker.addListener('click', () => {
                                infoWindow.open(map, marker);
                            });

                            employeeMarkers[username] = marker;
                        }
                    }

                    locationStatusDiv.innerHTML += statusHtml;
                }
            });
        }

        function startEmployeeLocationTracking() {
            if (currentUser.role !== 'employee') return;
            
            // Check if employee has checked in today
            const today = new Date().toDateString();
            const userAttendance = attendanceData[currentUser.username] || {};
            const todayRecord = userAttendance[today];
            
            if (todayRecord && todayRecord.checkIn && !todayRecord.checkOut) {
                // Employee is checked in, start tracking
                trackEmployeeLocation();
                setInterval(trackEmployeeLocation, 30000); // Update every 30 seconds
            }
        }

        function trackEmployeeLocation() {
            if (!navigator.geolocation) return;
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    const now = new Date();
                    const today = now.toDateString();
                    const timestamp = now.toLocaleTimeString('id-ID');
                    
                    // Store current location
                    if (!locationData[currentUser.username]) {
                        locationData[currentUser.username] = {};
                    }
                    
                    if (!locationData[currentUser.username][today]) {
                        locationData[currentUser.username][today] = {};
                    }
                    
                    locationData[currentUser.username][today].currentLocation = {
                        lat: userLat,
                        lng: userLng,
                        timestamp: timestamp,
                        lastUpdate: now.getTime()
                    };
                    
                    localStorage.setItem('locationData', JSON.stringify(locationData));
                },
                (error) => {
                    console.log('Location tracking failed:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 30000
                }
            );
        }

        function toggleLocationTracking() {
            const toggleBtn = document.getElementById('trackingToggle');
            const statusDiv = document.getElementById('trackingStatus');
            
            if (!isTrackingActive) {
                // Start tracking
                isTrackingActive = true;
                toggleBtn.innerHTML = '⏸️ Stop Tracking';
                toggleBtn.className = 'bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200 font-medium';
                statusDiv.innerHTML = '<div class="flex items-center justify-center space-x-2"><div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div><span class="text-green-700 font-medium">Tracking aktif - Memantau lokasi karyawan setiap 10 detik</span></div>';
                statusDiv.className = 'mb-4 p-3 bg-green-100 rounded-lg text-center text-sm';
                
                // Start real-time tracking
                locationTrackingInterval = setInterval(() => {
                    loadEmployeeLocations();
                }, 10000); // Update every 10 seconds
                
                // Initial load
                loadEmployeeLocations();
            } else {
                // Stop tracking
                isTrackingActive = false;
                toggleBtn.innerHTML = '▶️ Mulai Tracking';
                toggleBtn.className = 'bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 font-medium';
                statusDiv.innerHTML = 'Tracking tidak aktif - Klik "Mulai Tracking" untuk memantau lokasi real-time';
                statusDiv.className = 'mb-4 p-3 bg-gray-100 rounded-lg text-center text-sm text-gray-600';
                
                if (locationTrackingInterval) {
                    clearInterval(locationTrackingInterval);
                    locationTrackingInterval = null;
                }
            }
        }

        function refreshLocations() {
            loadEmployeeLocations();
            
            // Show refresh feedback
            const refreshBtn = document.querySelector('button[onclick="refreshLocations()"]');
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '🔄 Memperbarui...';
            refreshBtn.disabled = true;
            
            setTimeout(() => {
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
            }, 1000);
        }

        // Employee Management Functions
        function addNewEmployee() {
            const name = document.getElementById('newEmployeeName').value.trim();
            const username = document.getElementById('newEmployeeUsername').value.trim();
            const password = document.getElementById('newEmployeePassword').value.trim();

            if (!name || !username || !password) {
                alert('Semua field harus diisi!');
                return;
            }

            if (users[username]) {
                alert('Username sudah ada! Gunakan username lain.');
                return;
            }

            // Add new employee
            users[username] = {
                name: name,
                password: password,
                role: 'employee'
            };

            // Save to localStorage
            localStorage.setItem('users', JSON.stringify(users));

            // Clear form
            document.getElementById('newEmployeeName').value = '';
            document.getElementById('newEmployeeUsername').value = '';
            document.getElementById('newEmployeePassword').value = '';

            // Reload employee list and update selects
            loadEmployeeList();
            updateAdminStats();
            populateEmployeeSelect();

            alert('Karyawan baru berhasil ditambahkan!');
        }

        function loadEmployeeList() {
            const tbody = document.getElementById('employeeListTable');
            tbody.innerHTML = '';

            Object.keys(users).forEach(username => {
                const user = users[username];
                if (user.role === 'employee') {
                    const userAttendance = attendanceData[username] || {};
                    const totalAttendance = Object.keys(userAttendance).length;

                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-4 font-medium">${user.name}</td>
                        <td class="py-3 px-4">${username}</td>
                        <td class="py-3 px-4">
                            <input type="password" value="${user.password}" readonly class="bg-transparent border-none text-sm">
                            <button onclick="togglePasswordVisibility(this)" class="ml-2 text-blue-600 hover:underline text-xs">👁️</button>
                        </td>
                        <td class="py-3 px-4">${totalAttendance} hari</td>
                        <td class="py-3 px-4">
                            <div class="flex space-x-1">
                                <button onclick="editEmployee('${username}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">
                                    ✏️ Edit
                                </button>
                                <button onclick="deleteEmployee('${username}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                                    🗑️ Hapus
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }

        function togglePasswordVisibility(button) {
            const input = button.previousElementSibling;
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = '🙈';
            } else {
                input.type = 'password';
                button.textContent = '👁️';
            }
        }

        function editEmployee(username) {
            const user = users[username];
            const newName = prompt('Nama baru:', user.name);
            const newPassword = prompt('Password baru:', user.password);

            if (newName && newPassword) {
                users[username].name = newName;
                users[username].password = newPassword;
                localStorage.setItem('users', JSON.stringify(users));
                loadEmployeeList();
                loadAdminAttendanceTable();
                alert('Data karyawan berhasil diperbarui!');
            }
        }

        function deleteEmployee(username) {
            const user = users[username];
            if (confirm(`Apakah Anda yakin ingin menghapus karyawan "${user.name}"?\n\nSemua data absen karyawan ini juga akan terhapus!`)) {
                // Delete user
                delete users[username];
                
                // Delete attendance data
                delete attendanceData[username];
                
                // Delete location data
                delete locationData[username];

                // Save to localStorage
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                localStorage.setItem('locationData', JSON.stringify(locationData));

                // Reload data
                loadEmployeeList();
                loadAdminAttendanceTable();
                updateAdminStats();
                populateEmployeeSelect();

                alert('Karyawan dan semua data terkait berhasil dihapus!');
            }
        }

        // Attendance Management Functions
        function editAttendance(username, dateString) {
            currentEditUsername = username;
            currentEditDate = dateString;

            const user = users[username];
            const record = attendanceData[username][dateString];
            const date = new Date(dateString);

            document.getElementById('editEmployeeName').value = user.name;
            document.getElementById('editDate').value = date.toLocaleDateString('id-ID');
            
            // Convert time format for input
            if (record.checkIn) {
                const checkInTime = record.checkIn.split(':');
                document.getElementById('editCheckIn').value = `${checkInTime[0]}:${checkInTime[1]}`;
            } else {
                document.getElementById('editCheckIn').value = '';
            }
            
            if (record.checkOut) {
                const checkOutTime = record.checkOut.split(':');
                document.getElementById('editCheckOut').value = `${checkOutTime[0]}:${checkOutTime[1]}`;
            } else {
                document.getElementById('editCheckOut').value = '';
            }

            document.getElementById('editAttendanceModal').classList.remove('hidden');
        }

        function saveAttendanceEdit() {
            const checkInValue = document.getElementById('editCheckIn').value;
            const checkOutValue = document.getElementById('editCheckOut').value;

            if (!checkInValue && !checkOutValue) {
                alert('Minimal salah satu waktu harus diisi!');
                return;
            }

            // Convert back to display format
            const checkIn = checkInValue ? `${checkInValue}:00` : null;
            const checkOut = checkOutValue ? `${checkOutValue}:00` : null;

            // Update attendance data
            if (!attendanceData[currentEditUsername]) {
                attendanceData[currentEditUsername] = {};
            }
            
            if (!attendanceData[currentEditUsername][currentEditDate]) {
                attendanceData[currentEditUsername][currentEditDate] = {};
            }

            const record = attendanceData[currentEditUsername][currentEditDate];
            
            if (checkIn) record.checkIn = checkIn;
            if (checkOut) record.checkOut = checkOut;

            // Save to localStorage
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));

            // Reload table
            loadAdminAttendanceTable();
            updateAdminStats();
            closeEditModal();

            alert('Data absen berhasil diperbarui!');
        }

        function deleteAttendance(username, dateString) {
            const user = users[username];
            const date = new Date(dateString).toLocaleDateString('id-ID');
            
            if (confirm(`Apakah Anda yakin ingin menghapus data absen "${user.name}" pada tanggal ${date}?`)) {
                delete attendanceData[username][dateString];
                
                // Clean up empty user object
                if (Object.keys(attendanceData[username]).length === 0) {
                    delete attendanceData[username];
                }

                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                loadAdminAttendanceTable();
                updateAdminStats();
                
                alert('Data absen berhasil dihapus!');
            }
        }

        function closeEditModal() {
            document.getElementById('editAttendanceModal').classList.add('hidden');
            currentEditUsername = null;
            currentEditDate = null;
        }

        // Password Reset Functions
        function showPasswordReset() {
            document.getElementById('passwordResetModal').classList.remove('hidden');
            document.getElementById('resetStep1').classList.remove('hidden');
            document.getElementById('resetStep2').classList.add('hidden');
            document.getElementById('resetStep3').classList.add('hidden');
            document.getElementById('resetUsername').value = '';
            document.getElementById('usernameError').classList.add('hidden');
        }

        function closePasswordReset() {
            document.getElementById('passwordResetModal').classList.add('hidden');
            // Clear all fields
            document.getElementById('resetUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('usernameError').classList.add('hidden');
            document.getElementById('passwordError').classList.add('hidden');
        }

        function checkUsername() {
            const username = document.getElementById('resetUsername').value.trim();
            const errorDiv = document.getElementById('usernameError');

            if (!username) {
                errorDiv.textContent = 'Username tidak boleh kosong!';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (users[username]) {
                // Username found, proceed to step 2
                document.getElementById('foundUserName').textContent = users[username].name;
                document.getElementById('resetStep1').classList.add('hidden');
                document.getElementById('resetStep2').classList.remove('hidden');
                errorDiv.classList.add('hidden');
            } else {
                errorDiv.textContent = 'Username tidak ditemukan!';
                errorDiv.classList.remove('hidden');
            }
        }

        function backToStep1() {
            document.getElementById('resetStep2').classList.add('hidden');
            document.getElementById('resetStep1').classList.remove('hidden');
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordError').classList.add('hidden');
        }

        function resetPassword() {
            const username = document.getElementById('resetUsername').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
            const errorDiv = document.getElementById('passwordError');

            // Validation
            if (!newPassword || !confirmPassword) {
                errorDiv.textContent = 'Semua field password harus diisi!';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (newPassword.length < 3) {
                errorDiv.textContent = 'Password minimal 3 karakter!';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'Password dan konfirmasi password tidak sama!';
                errorDiv.classList.remove('hidden');
                return;
            }

            // Update password
            users[username].password = newPassword;
            localStorage.setItem('users', JSON.stringify(users));

            // Show success step
            document.getElementById('resetStep2').classList.add('hidden');
            document.getElementById('resetStep3').classList.remove('hidden');
            errorDiv.classList.add('hidden');
        }

        function closePasswordResetSuccess() {
            closePasswordReset();
            // Auto-fill username for convenience
            document.getElementById('username').value = document.getElementById('resetUsername').value;
        }

        function logout() {
            currentUser = null;
            
            // Clear saved session
            localStorage.removeItem('currentSession');
            
            // Stop location tracking
            if (locationTrackingInterval) {
                clearInterval(locationTrackingInterval);
                locationTrackingInterval = null;
            }
            isTrackingActive = false;
            
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('employeePage').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            // Close any open modals
            closeSelfieModal();
            closePhotoViewer();
            closeEditModal();
            closePasswordReset();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'978a289fe3baea7b',t:'MTc1Njc4NjIzNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
