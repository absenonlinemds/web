<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absen Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dw901SwHSRnpKr0&callback=initMap"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.2) 0%, transparent 50%);
            z-index: -2;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(45deg, transparent 40%, rgba(59, 130, 246, 0.1) 50%, transparent 60%),
                linear-gradient(-45deg, transparent 40%, rgba(16, 185, 129, 0.1) 50%, transparent 60%);
            background-size: 60px 60px;
            animation: networkFlow 20s linear infinite;
            z-index: -1;
        }
        
        @keyframes networkFlow {
            0% { transform: translateX(-60px) translateY(-60px); }
            100% { transform: translateX(60px) translateY(60px); }
        }
        
        .fiber-lines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .fiber-line {
            position: absolute;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.4), transparent);
            height: 1px;
            animation: fiberPulse 3s ease-in-out infinite;
        }
        
        .fiber-line:nth-child(1) {
            top: 20%;
            left: -100%;
            width: 200%;
            animation-delay: 0s;
        }
        
        .fiber-line:nth-child(2) {
            top: 40%;
            left: -100%;
            width: 200%;
            animation-delay: 1s;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.4), transparent);
        }
        
        .fiber-line:nth-child(3) {
            top: 60%;
            left: -100%;
            width: 200%;
            animation-delay: 2s;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.4), transparent);
        }
        
        .fiber-line:nth-child(4) {
            top: 80%;
            left: -100%;
            width: 200%;
            animation-delay: 0.5s;
        }
        
        @keyframes fiberPulse {
            0%, 100% { opacity: 0; transform: translateX(-50%); }
            50% { opacity: 1; transform: translateX(0%); }
        }
        
        .network-nodes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .network-node {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(59, 130, 246, 0.6);
            border-radius: 50%;
            animation: nodePulse 2s ease-in-out infinite;
        }
        
        .network-node:nth-child(1) { top: 15%; left: 10%; animation-delay: 0s; }
        .network-node:nth-child(2) { top: 25%; left: 85%; animation-delay: 0.5s; background: rgba(16, 185, 129, 0.6); }
        .network-node:nth-child(3) { top: 45%; left: 15%; animation-delay: 1s; background: rgba(139, 92, 246, 0.6); }
        .network-node:nth-child(4) { top: 65%; left: 80%; animation-delay: 1.5s; }
        .network-node:nth-child(5) { top: 75%; left: 20%; animation-delay: 0.3s; background: rgba(16, 185, 129, 0.6); }
        .network-node:nth-child(6) { top: 35%; left: 70%; animation-delay: 0.8s; background: rgba(139, 92, 246, 0.6); }
        
        @keyframes nodePulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .camera-container {
            position: relative;
            width: 300px;
            height: 225px;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            background: #f3f4f6;
        }
        
        #video, #canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #map {
            height: 300px;
            width: 100%;
            border-radius: 12px;
        }
        
        .location-status {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: 500;
        }
        
        .location-allowed {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        
        .location-denied {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        
        .glass-effect {
            background: white;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Fiber Optic Background Elements -->
    <div class="fiber-lines">
        <div class="fiber-line"></div>
        <div class="fiber-line"></div>
        <div class="fiber-line"></div>
        <div class="fiber-line"></div>
    </div>
    
    <div class="network-nodes">
        <div class="network-node"></div>
        <div class="network-node"></div>
        <div class="network-node"></div>
        <div class="network-node"></div>
        <div class="network-node"></div>
        <div class="network-node"></div>
    </div>
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl shadow-xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-white text-2xl">üë§</span>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Sistem Absen Online</h1>
                <p class="text-gray-600 mt-2">Silakan login untuk melakukan absen</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan username">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan password">
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                    Login
                </button>
            </form>
            
            <div id="loginError" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
                Username atau password salah!
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="mainScreen" class="hidden min-h-screen">
        <!-- Header -->
        <header class="glass-effect shadow-sm border-b border-white/20">
            <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold text-gray-800" id="dashboardTitle">Dashboard Absen</h1>
                    <p class="text-sm text-gray-600">Selamat datang, <span id="currentUser" class="font-medium"></span></p>
                </div>
                <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200">
                    Logout
                </button>
            </div>
        </header>

        <!-- Employee Dashboard -->
        <div id="employeeDashboard" class="max-w-4xl mx-auto p-4 space-y-6">
            <!-- Today's Attendance -->
            <div class="glass-effect rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Absen Hari Ini</h2>
                <div class="text-center">
                    <div class="text-3xl font-bold text-blue-600 mb-2" id="currentDate"></div>
                    <div class="text-lg text-gray-600 mb-6" id="currentTime"></div>
                    
                    <div id="attendanceStatus" class="mb-6">
                        <!-- Status akan diupdate via JavaScript -->
                    </div>
                    
                    <div id="attendanceButtons" class="space-y-4">
                        <button id="clockInBtn" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition duration-200 font-medium">
                            üïê Absen Masuk
                        </button>
                        <button id="clockOutBtn" class="w-full bg-orange-600 text-white py-3 rounded-lg hover:bg-orange-700 transition duration-200 font-medium hidden">
                            üïê Absen Keluar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Location & Camera Section -->
            <div id="locationSection" class="glass-effect rounded-xl shadow-lg p-6 hidden fade-in">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">Verifikasi Lokasi & Foto</h3>
                
                <!-- Location Status -->
                <div id="locationStatus" class="location-status">
                    üìç Memeriksa lokasi Anda...
                </div>
                
                <!-- Map -->
                <div id="mapContainer" class="mb-4 hidden">
                    <div id="map"></div>
                    <div class="text-center mt-2 text-sm text-gray-600">
                        <span id="distanceInfo">Jarak dari kantor: Menghitung...</span>
                    </div>
                </div>
                
                <!-- Camera -->
                <div id="cameraContainer" class="hidden">
                    <h4 class="text-md font-medium text-gray-700 mb-3 text-center">Ambil Foto Selfie</h4>
                    <div class="camera-container mb-4">
                        <video id="video" autoplay muted></video>
                        <canvas id="canvas" class="hidden"></canvas>
                    </div>
                    <div class="text-center space-y-3">
                        <button id="captureBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                            üì∏ Ambil Foto
                        </button>
                        <button id="retakeBtn" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition duration-200 hidden">
                            üîÑ Foto Ulang
                        </button>
                        <button id="confirmBtn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition duration-200 hidden">
                            ‚úÖ Konfirmasi Absen
                        </button>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <button id="cancelAttendance" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                        ‚ùå Batal
                    </button>
                </div>
            </div>

            <!-- Export Section -->
            <div class="glass-effect rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Export Data Absen</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <select id="monthSelect" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="0">Januari</option>
                        <option value="1">Februari</option>
                        <option value="2">Maret</option>
                        <option value="3">April</option>
                        <option value="4">Mei</option>
                        <option value="5">Juni</option>
                        <option value="6">Juli</option>
                        <option value="7">Agustus</option>
                        <option value="8">September</option>
                        <option value="9">Oktober</option>
                        <option value="10">November</option>
                        <option value="11">Desember</option>
                    </select>
                    <select id="yearSelect" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <!-- Tahun akan diisi via JavaScript -->
                    </select>
                    <button id="exportBtn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition duration-200 font-medium">
                        üìä Export Excel
                    </button>
                </div>
            </div>

            <!-- Attendance History -->
            <div class="glass-effect rounded-xl shadow-lg p-6 fade-in">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Riwayat Absen (7 Hari Terakhir)</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2">Tanggal</th>
                                <th class="text-left py-2">Masuk</th>
                                <th class="text-left py-2">Keluar</th>
                                <th class="text-left py-2">Status</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable">
                            <!-- Data akan diisi via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="max-w-6xl mx-auto p-4 space-y-6 hidden">
            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass-effect rounded-xl shadow-lg p-6">
                    <div class="flex items-center">
                        <div class="bg-green-100 p-3 rounded-full">
                            <span class="text-green-600 text-xl">üë•</span>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-semibold text-gray-800">Total Karyawan</h3>
                            <p class="text-2xl font-bold text-green-600" id="totalEmployees">3</p>
                        </div>
                    </div>
                </div>
                
                <div class="glass-effect rounded-xl shadow-lg p-6">
                    <div class="flex items-center">
                        <div class="bg-blue-100 p-3 rounded-full">
                            <span class="text-blue-600 text-xl">‚úÖ</span>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-semibold text-gray-800">Hadir Hari Ini</h3>
                            <p class="text-2xl font-bold text-blue-600" id="todayPresent">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="glass-effect rounded-xl shadow-lg p-6">
                    <div class="flex items-center">
                        <div class="bg-orange-100 p-3 rounded-full">
                            <span class="text-orange-600 text-xl">üìä</span>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-semibold text-gray-800">Total Absen</h3>
                            <p class="text-2xl font-bold text-orange-600" id="totalAttendance">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Export Section -->
            <div class="glass-effect rounded-xl shadow-lg p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Export Data Semua Karyawan</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <select id="adminMonthSelect" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Semua Bulan</option>
                        <option value="0">Januari</option>
                        <option value="1">Februari</option>
                        <option value="2">Maret</option>
                        <option value="3">April</option>
                        <option value="4">Mei</option>
                        <option value="5">Juni</option>
                        <option value="6">Juli</option>
                        <option value="7">Agustus</option>
                        <option value="8">September</option>
                        <option value="9">Oktober</option>
                        <option value="10">November</option>
                        <option value="11">Desember</option>
                    </select>
                    <select id="adminYearSelect" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <!-- Tahun akan diisi via JavaScript -->
                    </select>
                    <select id="employeeFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Semua Karyawan</option>
                        <option value="Wawan">Wawan</option>
                        <option value="Ebi">Ebi</option>
                        <option value="Dede">Dede</option>
                    </select>
                    <button id="adminExportBtn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition duration-200 font-medium">
                        üìä Export Excel
                    </button>
                </div>
            </div>

            <!-- Live Employee Locations -->
            <div class="glass-effect rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Lokasi Karyawan Aktif</h2>
                    <button id="refreshLocations" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                        üîÑ Refresh Lokasi
                    </button>
                </div>
                
                <!-- Live Location Map -->
                <div id="liveMap" style="height: 400px; width: 100%; border-radius: 12px; margin-bottom: 20px;"></div>
                
                <!-- Active Employees List -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div id="activeEmployeesList">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Location History Toggle -->
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-md font-medium text-gray-700">Riwayat Lokasi Hari Ini</h3>
                    <button id="toggleLocationHistory" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">
                        üìç Tampilkan Riwayat
                    </button>
                </div>
                
                <div id="locationHistoryTable" class="hidden overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b bg-gray-50">
                                <th class="text-left py-2 px-2">Waktu</th>
                                <th class="text-left py-2 px-2">Nama</th>
                                <th class="text-left py-2 px-2">Status</th>
                                <th class="text-left py-2 px-2">Jarak</th>
                                <th class="text-left py-2 px-2">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="locationHistoryBody">
                            <!-- Data akan diisi via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- All Employees Attendance Table -->
            <div class="glass-effect rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Data Absen Semua Karyawan</h2>
                    <div class="flex gap-2">
                        <select id="filterMonth" class="px-3 py-1 border border-gray-300 rounded text-sm">
                            <option value="">Semua Bulan</option>
                            <option value="0">Januari</option>
                            <option value="1">Februari</option>
                            <option value="2">Maret</option>
                            <option value="3">April</option>
                            <option value="4">Mei</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">Agustus</option>
                            <option value="8">September</option>
                            <option value="9">Oktober</option>
                            <option value="10">November</option>
                            <option value="11">Desember</option>
                        </select>
                        <button id="refreshData" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b bg-gray-50">
                                <th class="text-left py-3 px-2">Tanggal</th>
                                <th class="text-left py-3 px-2">Nama</th>
                                <th class="text-left py-3 px-2">Jam Masuk</th>
                                <th class="text-left py-3 px-2">Jam Keluar</th>
                                <th class="text-left py-3 px-2">Lokasi</th>
                                <th class="text-left py-3 px-2">Status</th>
                                <th class="text-left py-3 px-2">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="adminHistoryTable">
                            <!-- Data akan diisi via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data karyawan
        const employees = {
            'wawan': { password: 'wawan1', name: 'Wawan', role: 'employee' },
            'ebi': { password: 'ebi1', name: 'Ebi', role: 'employee' },
            'dede': { password: 'dede1', name: 'Dede', role: 'employee' },
            'admin': { password: 'mmd01', name: 'Administrator', role: 'admin' }
        };

        let currentUser = null;
        let stream = null;
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || {};
        let locationData = JSON.parse(localStorage.getItem('locationData')) || {};
        let map = null;
        let userMarker = null;
        let officeMarker = null;
        let radiusCircle = null;
        let currentPosition = null;
        let liveMap = null;
        let employeeMarkers = {};
        let locationUpdateInterval = null;
        
        // Koordinat kantor
        const OFFICE_LOCATION = {
            lat: -6.2190665,
            lng: 106.0912750
        };
        const OFFICE_RADIUS = 100; // meter

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            checkSavedSession();
            updateDateTime();
            setInterval(updateDateTime, 1000);
        });

        function initializeApp() {
            // Populate year selects
            const yearSelects = ['yearSelect', 'adminYearSelect'];
            const currentYear = new Date().getFullYear();
            
            yearSelects.forEach(selectId => {
                const yearSelect = document.getElementById(selectId);
                yearSelect.innerHTML = '';
                for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === currentYear) option.selected = true;
                    yearSelect.appendChild(option);
                }
            });

            // Set current month
            document.getElementById('monthSelect').value = new Date().getMonth();
            document.getElementById('adminMonthSelect').value = new Date().getMonth();

            // Event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('clockInBtn').addEventListener('click', startClockIn);
            document.getElementById('clockOutBtn').addEventListener('click', startClockOut);
            document.getElementById('captureBtn').addEventListener('click', capturePhoto);
            document.getElementById('retakeBtn').addEventListener('click', retakePhoto);
            document.getElementById('confirmBtn').addEventListener('click', confirmAttendance);
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            document.getElementById('adminExportBtn').addEventListener('click', adminExportToExcel);
            document.getElementById('refreshData').addEventListener('click', updateAdminTable);
            document.getElementById('filterMonth').addEventListener('change', updateAdminTable);
            document.getElementById('cancelAttendance').addEventListener('click', cancelAttendance);
            document.getElementById('refreshLocations').addEventListener('click', updateLiveLocations);
            document.getElementById('toggleLocationHistory').addEventListener('click', toggleLocationHistory);
        }

        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('id-ID', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const timeStr = now.toLocaleTimeString('id-ID');
            
            document.getElementById('currentDate').textContent = dateStr;
            document.getElementById('currentTime').textContent = timeStr;
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (employees[username] && employees[username].password === password) {
                currentUser = { 
                    username, 
                    name: employees[username].name, 
                    role: employees[username].role 
                };
                
                // Save session to localStorage
                localStorage.setItem('currentSession', JSON.stringify(currentUser));
                
                loginUser();
                document.getElementById('loginError').classList.add('hidden');
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function checkSavedSession() {
            const savedSession = localStorage.getItem('currentSession');
            if (savedSession) {
                try {
                    currentUser = JSON.parse(savedSession);
                    loginUser();
                } catch (error) {
                    console.log('Error loading saved session:', error);
                    localStorage.removeItem('currentSession');
                }
            }
        }

        function loginUser() {
            document.getElementById('currentUser').textContent = currentUser.name;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            
            if (currentUser.role === 'admin') {
                document.getElementById('dashboardTitle').textContent = 'Dashboard Admin';
                document.getElementById('employeeDashboard').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                updateAdminStats();
                updateAdminTable();
                initializeLiveMap();
                startLocationTracking();
            } else {
                document.getElementById('dashboardTitle').textContent = 'Dashboard Absen';
                document.getElementById('employeeDashboard').classList.remove('hidden');
                document.getElementById('adminDashboard').classList.add('hidden');
                updateAttendanceStatus();
                updateHistoryTable();
                startEmployeeLocationTracking();
            }
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentSession');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            stopCamera();
            stopLocationTracking();
        }

        function updateAttendanceStatus() {
            const today = new Date().toDateString();
            const userKey = `${currentUser.username}_${today}`;
            const todayAttendance = attendanceData[userKey];
            
            const statusDiv = document.getElementById('attendanceStatus');
            const clockInBtn = document.getElementById('clockInBtn');
            const clockOutBtn = document.getElementById('clockOutBtn');
            
            if (!todayAttendance) {
                statusDiv.innerHTML = '<div class="text-gray-600">Belum absen hari ini</div>';
                clockInBtn.classList.remove('hidden');
                clockInBtn.textContent = 'üïê Absen Masuk';
                clockOutBtn.classList.add('hidden');
            } else if (todayAttendance.clockIn && !todayAttendance.clockOut) {
                statusDiv.innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg">
                        ‚úÖ Sudah absen masuk: ${todayAttendance.clockIn}
                    </div>
                `;
                clockInBtn.classList.add('hidden');
                clockOutBtn.classList.remove('hidden');
            } else if (todayAttendance.clockIn && todayAttendance.clockOut) {
                // Show completed attendance but allow re-entry
                const allSessions = getAllTodaySessions(today);
                let sessionDisplay = '';
                
                allSessions.forEach((session, index) => {
                    sessionDisplay += `
                        <div class="mb-2">
                            <strong>Sesi ${index + 1}:</strong><br>
                            Masuk: ${session.clockIn} | Keluar: ${session.clockOut || 'Belum keluar'}
                        </div>
                    `;
                });
                
                statusDiv.innerHTML = `
                    <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-lg">
                        ‚úÖ Riwayat absen hari ini:<br>
                        ${sessionDisplay}
                    </div>
                `;
                
                // Allow re-entry after clocking out
                clockInBtn.classList.remove('hidden');
                clockInBtn.textContent = 'üîÑ Absen Masuk Lagi';
                clockOutBtn.classList.add('hidden');
            }
        }

        function startClockIn() {
            currentAttendanceType = 'clockIn';
            startLocationVerification();
        }

        function startClockOut() {
            currentAttendanceType = 'clockOut';
            startLocationVerification();
        }

        function startCamera() {
            document.getElementById('cameraContainer').classList.remove('hidden');
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(mediaStream) {
                    stream = mediaStream;
                    document.getElementById('video').srcObject = stream;
                })
                .catch(function(err) {
                    alert('Tidak dapat mengakses kamera: ' + err.message);
                });
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            document.getElementById('locationSection').classList.add('hidden');
            document.getElementById('cameraContainer').classList.add('hidden');
            document.getElementById('mapContainer').classList.add('hidden');
            document.getElementById('video').classList.remove('hidden');
            document.getElementById('canvas').classList.add('hidden');
            document.getElementById('captureBtn').classList.remove('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('confirmBtn').classList.add('hidden');
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            video.classList.add('hidden');
            canvas.classList.remove('hidden');
            document.getElementById('captureBtn').classList.add('hidden');
            document.getElementById('retakeBtn').classList.remove('hidden');
            document.getElementById('confirmBtn').classList.remove('hidden');
        }

        function retakePhoto() {
            document.getElementById('video').classList.remove('hidden');
            document.getElementById('canvas').classList.add('hidden');
            document.getElementById('captureBtn').classList.remove('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('confirmBtn').classList.add('hidden');
        }

        function confirmAttendance() {
            const now = new Date();
            const today = now.toDateString();
            const timeStr = now.toLocaleTimeString('id-ID');
            
            if (currentAttendanceType === 'clockIn') {
                // For clock in, create new session
                const sessionKey = `${currentUser.username}_${today}_${Date.now()}`;
                attendanceData[sessionKey] = {
                    clockIn: timeStr,
                    date: today,
                    user: currentUser.name,
                    sessionId: Date.now()
                };
                
                // Simpan foto dan lokasi untuk clock in
                const canvas = document.getElementById('canvas');
                attendanceData[sessionKey].clockInPhoto = canvas.toDataURL();
                
                if (currentPosition) {
                    attendanceData[sessionKey].clockInLocation = {
                        lat: currentPosition.lat,
                        lng: currentPosition.lng,
                        distance: calculateDistance(currentPosition, OFFICE_LOCATION)
                    };
                }
                
                // Update current session reference
                const userKey = `${currentUser.username}_${today}`;
                attendanceData[userKey] = attendanceData[sessionKey];
                
            } else {
                // For clock out, update current session
                const userKey = `${currentUser.username}_${today}`;
                if (attendanceData[userKey] && attendanceData[userKey].sessionId) {
                    const sessionKey = `${currentUser.username}_${today}_${attendanceData[userKey].sessionId}`;
                    if (attendanceData[sessionKey]) {
                        attendanceData[sessionKey].clockOut = timeStr;
                        
                        // Simpan foto dan lokasi untuk clock out
                        const canvas = document.getElementById('canvas');
                        attendanceData[sessionKey].clockOutPhoto = canvas.toDataURL();
                        
                        if (currentPosition) {
                            attendanceData[sessionKey].clockOutLocation = {
                                lat: currentPosition.lat,
                                lng: currentPosition.lng,
                                distance: calculateDistance(currentPosition, OFFICE_LOCATION)
                            };
                        }
                        
                        // Update main reference
                        attendanceData[userKey] = attendanceData[sessionKey];
                    }
                }
            }
            
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            
            stopCamera();
            updateAttendanceStatus();
            updateHistoryTable();
            
            alert(`Absen ${currentAttendanceType === 'clockIn' ? 'masuk' : 'keluar'} berhasil!`);
        }

        function getAllTodaySessions(today) {
            const sessions = [];
            const userPrefix = `${currentUser.username}_${today}_`;
            
            Object.keys(attendanceData).forEach(key => {
                if (key.startsWith(userPrefix) && key !== `${currentUser.username}_${today}`) {
                    sessions.push(attendanceData[key]);
                }
            });
            
            // Sort by session ID (timestamp)
            sessions.sort((a, b) => (a.sessionId || 0) - (b.sessionId || 0));
            return sessions;
        }

        function updateHistoryTable() {
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = '';
            
            // Get unique dates for the user
            const userDates = new Set();
            Object.values(attendanceData)
                .filter(record => record.user === currentUser.name)
                .forEach(record => userDates.add(record.date));
            
            // Convert to array and sort
            const sortedDates = Array.from(userDates)
                .sort((a, b) => new Date(b) - new Date(a))
                .slice(0, 7);
            
            sortedDates.forEach(date => {
                const sessions = getAllTodaySessionsForDate(date);
                
                if (sessions.length > 0) {
                    sessions.forEach((session, index) => {
                        const row = document.createElement('tr');
                        row.className = 'border-b hover:bg-gray-50';
                        
                        const dateStr = new Date(session.date).toLocaleDateString('id-ID');
                        const displayDate = index === 0 ? dateStr : '';
                        const sessionLabel = sessions.length > 1 ? ` (Sesi ${index + 1})` : '';
                        const clockIn = session.clockIn || '-';
                        const clockOut = session.clockOut || '-';
                        const status = session.clockIn && session.clockOut ? 
                            '<span class="text-green-600">‚úÖ Lengkap</span>' : 
                            '<span class="text-orange-600">‚è≥ Belum lengkap</span>';
                        
                        row.innerHTML = `
                            <td class="py-2">${displayDate}${sessionLabel}</td>
                            <td class="py-2">${clockIn}</td>
                            <td class="py-2">${clockOut}</td>
                            <td class="py-2">${status}</td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                }
            });
        }

        function getAllTodaySessionsForDate(date) {
            const sessions = [];
            const userPrefix = `${currentUser.username}_${date}_`;
            
            Object.keys(attendanceData).forEach(key => {
                if (key.startsWith(userPrefix) && key !== `${currentUser.username}_${date}`) {
                    sessions.push(attendanceData[key]);
                }
            });
            
            // Sort by session ID (timestamp)
            sessions.sort((a, b) => (a.sessionId || 0) - (b.sessionId || 0));
            return sessions;
        }

        function exportToExcel() {
            const month = parseInt(document.getElementById('monthSelect').value);
            const year = parseInt(document.getElementById('yearSelect').value);
            
            const filteredData = Object.values(attendanceData)
                .filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getMonth() === month && recordDate.getFullYear() === year;
                })
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (filteredData.length === 0) {
                alert('Tidak ada data absen untuk bulan dan tahun yang dipilih');
                return;
            }
            
            const excelData = filteredData.map(record => ({
                'Tanggal': new Date(record.date).toLocaleDateString('id-ID'),
                'Nama': record.user,
                'Jam Masuk': record.clockIn || '-',
                'Jam Keluar': record.clockOut || '-',
                'Status': record.clockIn && record.clockOut ? 'Lengkap' : 'Belum Lengkap'
            }));
            
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data Absen');
            
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const filename = `Absen_${monthNames[month]}_${year}.xlsx`;
            
            XLSX.writeFile(wb, filename);
        }

        let currentAttendanceType = '';

        // Fungsi untuk memulai verifikasi lokasi
        function startLocationVerification() {
            document.getElementById('locationSection').classList.remove('hidden');
            document.getElementById('locationStatus').innerHTML = 'üìç Memeriksa lokasi Anda...';
            document.getElementById('locationStatus').className = 'location-status';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    handleLocationSuccess,
                    handleLocationError,
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                handleLocationError({ code: 0, message: 'Geolocation tidak didukung browser' });
            }
        }

        function handleLocationSuccess(position) {
            currentPosition = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            const distance = calculateDistance(currentPosition, OFFICE_LOCATION);
            
            if (distance <= OFFICE_RADIUS) {
                document.getElementById('locationStatus').innerHTML = 
                    `‚úÖ Lokasi valid! Jarak: ${Math.round(distance)}m dari kantor`;
                document.getElementById('locationStatus').className = 'location-status location-allowed';
                
                // Tampilkan peta dan lanjut ke kamera
                showMap();
                setTimeout(() => {
                    startCamera();
                }, 1000);
            } else {
                document.getElementById('locationStatus').innerHTML = 
                    `‚ùå Anda terlalu jauh dari kantor! Jarak: ${Math.round(distance)}m (Max: ${OFFICE_RADIUS}m)`;
                document.getElementById('locationStatus').className = 'location-status location-denied';
                showMap();
            }
        }

        function handleLocationError(error) {
            let message = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = '‚ùå Akses lokasi ditolak. Mohon izinkan akses lokasi untuk melakukan absen.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = '‚ùå Informasi lokasi tidak tersedia.';
                    break;
                case error.TIMEOUT:
                    message = '‚ùå Timeout mendapatkan lokasi.';
                    break;
                default:
                    message = '‚ùå Error mendapatkan lokasi: ' + error.message;
                    break;
            }
            
            document.getElementById('locationStatus').innerHTML = message;
            document.getElementById('locationStatus').className = 'location-status location-denied';
        }

        function showMap() {
            document.getElementById('mapContainer').classList.remove('hidden');
            
            if (!map) {
                initMap();
            } else {
                updateMapMarkers();
            }
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 17,
                center: OFFICE_LOCATION,
                mapTypeId: 'roadmap'
            });

            // Marker kantor
            officeMarker = new google.maps.Marker({
                position: OFFICE_LOCATION,
                map: map,
                title: 'Kantor',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="20" cy="20" r="18" fill="#3B82F6" stroke="white" stroke-width="2"/>
                            <text x="20" y="26" text-anchor="middle" fill="white" font-size="16">üè¢</text>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(40, 40)
                }
            });

            // Radius circle
            radiusCircle = new google.maps.Circle({
                strokeColor: '#3B82F6',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#3B82F6',
                fillOpacity: 0.15,
                map: map,
                center: OFFICE_LOCATION,
                radius: OFFICE_RADIUS
            });

            updateMapMarkers();
        }

        function updateMapMarkers() {
            if (currentPosition && map) {
                // Update user marker
                if (userMarker) {
                    userMarker.setMap(null);
                }

                const distance = calculateDistance(currentPosition, OFFICE_LOCATION);
                const isInRange = distance <= OFFICE_RADIUS;

                userMarker = new google.maps.Marker({
                    position: currentPosition,
                    map: map,
                    title: 'Lokasi Anda',
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="20" cy="20" r="18" fill="${isInRange ? '#10B981' : '#EF4444'}" stroke="white" stroke-width="2"/>
                                <text x="20" y="26" text-anchor="middle" fill="white" font-size="16">üìç</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(40, 40)
                    }
                });

                // Update distance info
                document.getElementById('distanceInfo').textContent = 
                    `Jarak dari kantor: ${Math.round(distance)}m`;

                // Center map between office and user
                const bounds = new google.maps.LatLngBounds();
                bounds.extend(OFFICE_LOCATION);
                bounds.extend(currentPosition);
                map.fitBounds(bounds);
            }
        }

        function calculateDistance(pos1, pos2) {
            const R = 6371e3; // Earth's radius in meters
            const œÜ1 = pos1.lat * Math.PI/180;
            const œÜ2 = pos2.lat * Math.PI/180;
            const ŒîœÜ = (pos2.lat-pos1.lat) * Math.PI/180;
            const ŒîŒª = (pos2.lng-pos1.lng) * Math.PI/180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distance in meters
        }

        function cancelAttendance() {
            stopCamera();
        }

        function updateAdminStats() {
            const today = new Date().toDateString();
            const todayAttendance = Object.values(attendanceData)
                .filter(record => record.date === today && record.clockIn);
            
            document.getElementById('todayPresent').textContent = todayAttendance.length;
            document.getElementById('totalAttendance').textContent = Object.keys(attendanceData).length;
        }

        function updateAdminTable() {
            const tbody = document.getElementById('adminHistoryTable');
            tbody.innerHTML = '';
            
            const filterMonth = document.getElementById('filterMonth').value;
            
            // Get all session records (not just main references)
            let filteredData = Object.entries(attendanceData)
                .filter(([key, record]) => {
                    // Include session records and main references
                    return record.user && record.date && record.clockIn;
                })
                .map(([key, record]) => ({ ...record, key }));
            
            if (filterMonth !== '') {
                filteredData = filteredData.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getMonth() === parseInt(filterMonth);
                });
            }
            
            // Sort by date and session ID
            filteredData.sort((a, b) => {
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                return (b.sessionId || 0) - (a.sessionId || 0);
            });
            
            filteredData.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                const date = new Date(record.date).toLocaleDateString('id-ID');
                const clockIn = record.clockIn || '-';
                const clockOut = record.clockOut || '-';
                const status = record.clockIn && record.clockOut ? 
                    '<span class="text-green-600">‚úÖ Lengkap</span>' : 
                    '<span class="text-orange-600">‚è≥ Belum lengkap</span>';
                
                // Info lokasi
                let locationInfo = '-';
                if (record.clockInLocation) {
                    const distance = Math.round(record.clockInLocation.distance);
                    const isValid = distance <= OFFICE_RADIUS;
                    locationInfo = `<span class="${isValid ? 'text-green-600' : 'text-red-600'}">${distance}m</span>`;
                }
                
                // Session indicator
                const sessionLabel = record.sessionId ? 
                    `<small class="text-gray-500">(${new Date(record.sessionId).toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})})</small>` : '';
                
                row.innerHTML = `
                    <td class="py-2 px-2">${date} ${sessionLabel}</td>
                    <td class="py-2 px-2 font-medium">${record.user}</td>
                    <td class="py-2 px-2">${clockIn}</td>
                    <td class="py-2 px-2">${clockOut}</td>
                    <td class="py-2 px-2">${locationInfo}</td>
                    <td class="py-2 px-2">${status}</td>
                    <td class="py-2 px-2">
                        <button onclick="viewSessionPhoto('${record.key}')" 
                                class="text-blue-600 hover:text-blue-800 text-sm mr-2">
                            üì∑ Foto
                        </button>
                        ${record.clockInLocation ? `
                            <button onclick="viewSessionLocation('${record.key}')" 
                                    class="text-green-600 hover:text-green-800 text-sm">
                                üìç Lokasi
                            </button>
                        ` : ''}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            updateAdminStats();
        }

        function viewSessionPhoto(sessionKey) {
            const record = attendanceData[sessionKey];
            
            if (record && (record.clockInPhoto || record.clockOutPhoto)) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <h3 class="text-lg font-semibold mb-4">Foto Absen - ${record.user}</h3>
                        <div class="text-sm text-gray-600 mb-4">
                            ${new Date(record.date).toLocaleDateString('id-ID')}
                            ${record.sessionId ? `<br><small>Sesi: ${new Date(record.sessionId).toLocaleTimeString('id-ID')}</small>` : ''}
                        </div>
                        ${record.clockInPhoto ? `
                            <div class="mb-4">
                                <p class="text-sm font-medium mb-2">Foto Absen Masuk:</p>
                                <img src="${record.clockInPhoto}" class="w-full rounded-lg">
                            </div>
                        ` : ''}
                        ${record.clockOutPhoto ? `
                            <div class="mb-4">
                                <p class="text-sm font-medium mb-2">Foto Absen Keluar:</p>
                                <img src="${record.clockOutPhoto}" class="w-full rounded-lg">
                            </div>
                        ` : ''}
                        <button onclick="this.parentElement.parentElement.remove()" 
                                class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                            Tutup
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                alert('Foto tidak tersedia untuk absen ini');
            }
        }

        function viewPhoto(user, date) {
            // Legacy function for backward compatibility
            const userKey = `${user.toLowerCase()}_${date}`;
            viewSessionPhoto(userKey);
        }

        function viewSessionLocation(sessionKey) {
            const record = attendanceData[sessionKey];
            
            if (record && record.clockInLocation) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
                        <h3 class="text-lg font-semibold mb-4">Lokasi Absen - ${record.user}</h3>
                        <div class="text-sm text-gray-600 mb-4">
                            ${new Date(record.date).toLocaleDateString('id-ID')}
                            ${record.sessionId ? `<br><small>Sesi: ${new Date(record.sessionId).toLocaleTimeString('id-ID')}</small>` : ''}
                        </div>
                        <div class="mb-4">
                            <div id="modalMap" style="height: 300px; width: 100%; border-radius: 8px;"></div>
                        </div>
                        <div class="text-sm text-gray-600 mb-4">
                            <p><strong>Jarak dari kantor:</strong> ${Math.round(record.clockInLocation.distance)}m</p>
                            <p><strong>Koordinat:</strong> ${record.clockInLocation.lat.toFixed(6)}, ${record.clockInLocation.lng.toFixed(6)}</p>
                            <p><strong>Status:</strong> 
                                <span class="${record.clockInLocation.distance <= OFFICE_RADIUS ? 'text-green-600' : 'text-red-600'}">
                                    ${record.clockInLocation.distance <= OFFICE_RADIUS ? '‚úÖ Valid' : '‚ùå Terlalu jauh'}
                                </span>
                            </p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" 
                                class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                            Tutup
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Initialize map in modal
                setTimeout(() => {
                    const modalMap = new google.maps.Map(document.getElementById('modalMap'), {
                        zoom: 17,
                        center: OFFICE_LOCATION,
                        mapTypeId: 'roadmap'
                    });

                    // Office marker
                    new google.maps.Marker({
                        position: OFFICE_LOCATION,
                        map: modalMap,
                        title: 'Kantor',
                        icon: {
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                <svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="15" cy="15" r="13" fill="#3B82F6" stroke="white" stroke-width="2"/>
                                    <text x="15" y="19" text-anchor="middle" fill="white" font-size="12">üè¢</text>
                                </svg>
                            `),
                            scaledSize: new google.maps.Size(30, 30)
                        }
                    });

                    // User marker
                    const isValid = record.clockInLocation.distance <= OFFICE_RADIUS;
                    new google.maps.Marker({
                        position: record.clockInLocation,
                        map: modalMap,
                        title: 'Lokasi Absen',
                        icon: {
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                <svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="15" cy="15" r="13" fill="${isValid ? '#10B981' : '#EF4444'}" stroke="white" stroke-width="2"/>
                                    <text x="15" y="19" text-anchor="middle" fill="white" font-size="12">üìç</text>
                                </svg>
                            `),
                            scaledSize: new google.maps.Size(30, 30)
                        }
                    });

                    // Radius circle
                    new google.maps.Circle({
                        strokeColor: '#3B82F6',
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: '#3B82F6',
                        fillOpacity: 0.15,
                        map: modalMap,
                        center: OFFICE_LOCATION,
                        radius: OFFICE_RADIUS
                    });

                    // Fit bounds
                    const bounds = new google.maps.LatLngBounds();
                    bounds.extend(OFFICE_LOCATION);
                    bounds.extend(record.clockInLocation);
                    modalMap.fitBounds(bounds);
                }, 100);
            } else {
                alert('Data lokasi tidak tersedia untuk absen ini');
            }
        }

        function viewLocation(user, date) {
            // Legacy function for backward compatibility
            const userKey = `${user.toLowerCase()}_${date}`;
            viewSessionLocation(userKey);
        }

        function adminExportToExcel() {
            const month = document.getElementById('adminMonthSelect').value;
            const year = parseInt(document.getElementById('adminYearSelect').value);
            const employee = document.getElementById('employeeFilter').value;
            
            let filteredData = Object.values(attendanceData);
            
            // Filter by month if selected
            if (month !== '') {
                filteredData = filteredData.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getMonth() === parseInt(month);
                });
            }
            
            // Filter by year
            filteredData = filteredData.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getFullYear() === year;
            });
            
            // Filter by employee if selected
            if (employee !== '') {
                filteredData = filteredData.filter(record => record.user === employee);
            }
            
            if (filteredData.length === 0) {
                alert('Tidak ada data absen untuk filter yang dipilih');
                return;
            }
            
            filteredData.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const excelData = filteredData.map(record => ({
                'Tanggal': new Date(record.date).toLocaleDateString('id-ID'),
                'Nama Karyawan': record.user,
                'Jam Masuk': record.clockIn || '-',
                'Jam Keluar': record.clockOut || '-',
                'Jarak dari Kantor (m)': record.clockInLocation ? Math.round(record.clockInLocation.distance) : '-',
                'Status Lokasi': record.clockInLocation ? 
                    (record.clockInLocation.distance <= OFFICE_RADIUS ? 'Valid' : 'Terlalu Jauh') : '-',
                'Status Absen': record.clockIn && record.clockOut ? 'Lengkap' : 'Belum Lengkap',
                'Durasi Kerja': calculateWorkDuration(record.clockIn, record.clockOut),
                'Koordinat': record.clockInLocation ? 
                    `${record.clockInLocation.lat.toFixed(6)}, ${record.clockInLocation.lng.toFixed(6)}` : '-'
            }));
            
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data Absen');
            
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            let filename = 'Data_Absen_';
            if (employee) filename += `${employee}_`;
            if (month !== '') filename += `${monthNames[parseInt(month)]}_`;
            filename += `${year}.xlsx`;
            
            XLSX.writeFile(wb, filename);
        }

        function calculateWorkDuration(clockIn, clockOut) {
            if (!clockIn || !clockOut) return '-';
            
            const [inHour, inMin] = clockIn.split(':').map(Number);
            const [outHour, outMin] = clockOut.split(':').map(Number);
            
            const inMinutes = inHour * 60 + inMin;
            const outMinutes = outHour * 60 + outMin;
            
            const diffMinutes = outMinutes - inMinutes;
            const hours = Math.floor(diffMinutes / 60);
            const minutes = diffMinutes % 60;
            
            return `${hours}j ${minutes}m`;
        }

        // Live Location Tracking Functions
        function startEmployeeLocationTracking() {
            if (navigator.geolocation) {
                // Update location every 30 seconds for active employees
                locationUpdateInterval = setInterval(() => {
                    if (isEmployeeActive()) {
                        updateEmployeeLocation();
                    }
                }, 30000);
                
                // Initial location update
                if (isEmployeeActive()) {
                    updateEmployeeLocation();
                }
            }
        }

        function isEmployeeActive() {
            const today = new Date().toDateString();
            const userKey = `${currentUser.username}_${today}`;
            const todayAttendance = attendanceData[userKey];
            
            // Employee is active if they have clocked in but not clocked out
            return todayAttendance && todayAttendance.clockIn && !todayAttendance.clockOut;
        }

        function updateEmployeeLocation() {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const locationKey = `${currentUser.username}_${Date.now()}`;
                    const now = new Date();
                    
                    locationData[locationKey] = {
                        user: currentUser.name,
                        username: currentUser.username,
                        timestamp: now.toISOString(),
                        time: now.toLocaleTimeString('id-ID'),
                        date: now.toDateString(),
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        distance: calculateDistance(
                            { lat: position.coords.latitude, lng: position.coords.longitude },
                            OFFICE_LOCATION
                        ),
                        status: 'active'
                    };
                    
                    localStorage.setItem('locationData', JSON.stringify(locationData));
                },
                (error) => {
                    console.log('Location update failed:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        function stopLocationTracking() {
            if (locationUpdateInterval) {
                clearInterval(locationUpdateInterval);
                locationUpdateInterval = null;
            }
            
            // Mark employee as inactive
            if (currentUser && currentUser.role === 'employee') {
                const now = new Date();
                const locationKey = `${currentUser.username}_${Date.now()}`;
                
                locationData[locationKey] = {
                    user: currentUser.name,
                    username: currentUser.username,
                    timestamp: now.toISOString(),
                    time: now.toLocaleTimeString('id-ID'),
                    date: now.toDateString(),
                    status: 'offline'
                };
                
                localStorage.setItem('locationData', JSON.stringify(locationData));
            }
        }

        function initializeLiveMap() {
            setTimeout(() => {
                liveMap = new google.maps.Map(document.getElementById('liveMap'), {
                    zoom: 15,
                    center: OFFICE_LOCATION,
                    mapTypeId: 'roadmap'
                });

                // Office marker
                new google.maps.Marker({
                    position: OFFICE_LOCATION,
                    map: liveMap,
                    title: 'Kantor',
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="20" cy="20" r="18" fill="#3B82F6" stroke="white" stroke-width="3"/>
                                <text x="20" y="26" text-anchor="middle" fill="white" font-size="16">üè¢</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(40, 40)
                    }
                });

                // Office radius
                new google.maps.Circle({
                    strokeColor: '#3B82F6',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#3B82F6',
                    fillOpacity: 0.15,
                    map: liveMap,
                    center: OFFICE_LOCATION,
                    radius: OFFICE_RADIUS
                });

                updateLiveLocations();
            }, 500);
        }

        function startLocationTracking() {
            // Auto-refresh every 60 seconds
            setInterval(updateLiveLocations, 60000);
        }

        function updateLiveLocations() {
            if (!liveMap) return;
            
            // Clear existing employee markers
            Object.values(employeeMarkers).forEach(marker => marker.setMap(null));
            employeeMarkers = {};
            
            // Get active employees (those who are currently working)
            const activeEmployees = getActiveEmployees();
            const activeEmployeesList = document.getElementById('activeEmployeesList');
            
            activeEmployeesList.innerHTML = '';
            
            if (activeEmployees.length === 0) {
                activeEmployeesList.innerHTML = `
                    <div class="col-span-3 text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">üò¥</div>
                        <p>Tidak ada karyawan yang sedang bekerja</p>
                    </div>
                `;
                return;
            }
            
            activeEmployees.forEach(employee => {
                // Add marker to map
                const isInRange = employee.distance <= OFFICE_RADIUS;
                const marker = new google.maps.Marker({
                    position: { lat: employee.lat, lng: employee.lng },
                    map: liveMap,
                    title: employee.user,
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="35" height="35" viewBox="0 0 35 35" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="17.5" cy="17.5" r="15" fill="${isInRange ? '#10B981' : '#EF4444'}" stroke="white" stroke-width="2"/>
                                <text x="17.5" y="22" text-anchor="middle" fill="white" font-size="14">üë§</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(35, 35)
                    }
                });
                
                // Info window
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div class="p-2">
                            <h4 class="font-semibold">${employee.user}</h4>
                            <p class="text-sm text-gray-600">Update: ${employee.time}</p>
                            <p class="text-sm">Jarak: ${Math.round(employee.distance)}m</p>
                            <p class="text-sm">Status: <span class="${isInRange ? 'text-green-600' : 'text-red-600'}">${isInRange ? 'Di area kantor' : 'Di luar area'}</span></p>
                        </div>
                    `
                });
                
                marker.addListener('click', () => {
                    // Close other info windows
                    Object.values(employeeMarkers).forEach(m => {
                        if (m.infoWindow) m.infoWindow.close();
                    });
                    infoWindow.open(liveMap, marker);
                });
                
                marker.infoWindow = infoWindow;
                employeeMarkers[employee.username] = marker;
                
                // Add to active employees list
                const employeeCard = document.createElement('div');
                employeeCard.className = `bg-gray-50 rounded-lg p-4 border-l-4 ${isInRange ? 'border-green-500' : 'border-red-500'}`;
                employeeCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold text-gray-800">${employee.user}</h4>
                            <p class="text-sm text-gray-600">Update: ${employee.time}</p>
                            <p class="text-sm text-gray-600">Jarak: ${Math.round(employee.distance)}m</p>
                        </div>
                        <div class="text-right">
                            <div class="${isInRange ? 'text-green-600' : 'text-red-600'} font-medium text-sm">
                                ${isInRange ? '‚úÖ Di kantor' : '‚ùå Di luar'}
                            </div>
                            <button onclick="focusOnEmployee('${employee.username}')" 
                                    class="text-blue-600 hover:text-blue-800 text-sm mt-1">
                                üìç Lihat di peta
                            </button>
                        </div>
                    </div>
                `;
                
                activeEmployeesList.appendChild(employeeCard);
            });
            
            updateLocationHistory();
        }

        function getActiveEmployees() {
            const today = new Date().toDateString();
            const activeEmployees = [];
            
            // Get employees who are currently working (clocked in but not out)
            const workingEmployees = Object.values(attendanceData)
                .filter(record => record.date === today && record.clockIn && !record.clockOut)
                .map(record => record.user);
            
            // Get latest location for each working employee
            workingEmployees.forEach(employeeName => {
                const username = Object.keys(employees).find(key => 
                    employees[key].name === employeeName && employees[key].role === 'employee'
                );
                
                if (username) {
                    const latestLocation = getLatestEmployeeLocation(username);
                    if (latestLocation && latestLocation.status === 'active') {
                        activeEmployees.push(latestLocation);
                    }
                }
            });
            
            return activeEmployees;
        }

        function getLatestEmployeeLocation(username) {
            const userLocations = Object.values(locationData)
                .filter(loc => loc.username === username)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Return latest location if it's within the last 5 minutes
            if (userLocations.length > 0) {
                const latest = userLocations[0];
                const timeDiff = Date.now() - new Date(latest.timestamp).getTime();
                if (timeDiff < 5 * 60 * 1000) { // 5 minutes
                    return latest;
                }
            }
            
            return null;
        }

        function focusOnEmployee(username) {
            const marker = employeeMarkers[username];
            if (marker && liveMap) {
                liveMap.setCenter(marker.getPosition());
                liveMap.setZoom(18);
                if (marker.infoWindow) {
                    marker.infoWindow.open(liveMap, marker);
                }
            }
        }

        function toggleLocationHistory() {
            const historyTable = document.getElementById('locationHistoryTable');
            const toggleBtn = document.getElementById('toggleLocationHistory');
            
            if (historyTable.classList.contains('hidden')) {
                historyTable.classList.remove('hidden');
                toggleBtn.textContent = 'üìç Sembunyikan Riwayat';
                updateLocationHistory();
            } else {
                historyTable.classList.add('hidden');
                toggleBtn.textContent = 'üìç Tampilkan Riwayat';
            }
        }

        function updateLocationHistory() {
            const tbody = document.getElementById('locationHistoryBody');
            tbody.innerHTML = '';
            
            const today = new Date().toDateString();
            const todayLocations = Object.values(locationData)
                .filter(loc => loc.date === today)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 50); // Show last 50 location updates
            
            todayLocations.forEach(location => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                const isInRange = location.distance <= OFFICE_RADIUS;
                const statusColor = location.status === 'active' ? 
                    (isInRange ? 'text-green-600' : 'text-orange-600') : 'text-gray-500';
                const statusText = location.status === 'active' ? 
                    (isInRange ? '‚úÖ Aktif di kantor' : '‚ö†Ô∏è Aktif di luar') : '‚≠ï Offline';
                
                row.innerHTML = `
                    <td class="py-2 px-2">${location.time}</td>
                    <td class="py-2 px-2 font-medium">${location.user}</td>
                    <td class="py-2 px-2 ${statusColor}">${statusText}</td>
                    <td class="py-2 px-2">${location.distance ? Math.round(location.distance) + 'm' : '-'}</td>
                    <td class="py-2 px-2">
                        ${location.lat && location.lng ? `
                            <button onclick="viewLocationOnMap(${location.lat}, ${location.lng}, '${location.user}', '${location.time}')" 
                                    class="text-blue-600 hover:text-blue-800 text-sm">
                                üìç Lihat
                            </button>
                        ` : '-'}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function viewLocationOnMap(lat, lng, userName, time) {
            if (liveMap) {
                const position = { lat: lat, lng: lng };
                liveMap.setCenter(position);
                liveMap.setZoom(18);
                
                // Create temporary marker
                const tempMarker = new google.maps.Marker({
                    position: position,
                    map: liveMap,
                    title: `${userName} - ${time}`,
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="15" cy="15" r="13" fill="#F59E0B" stroke="white" stroke-width="2"/>
                                <text x="15" y="19" text-anchor="middle" fill="white" font-size="12">üìç</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(30, 30)
                    }
                });
                
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div class="p-2">
                            <h4 class="font-semibold">${userName}</h4>
                            <p class="text-sm text-gray-600">Waktu: ${time}</p>
                            <p class="text-sm text-gray-600">Riwayat lokasi</p>
                        </div>
                    `
                });
                
                infoWindow.open(liveMap, tempMarker);
                
                // Remove temporary marker after 10 seconds
                setTimeout(() => {
                    tempMarker.setMap(null);
                    infoWindow.close();
                }, 10000);
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9786bba1e35ab29b',t:'MTc1Njc1MDMxNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
